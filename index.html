<!DOCTYPE html>
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ V4.1 - Gemini AI ğŸš€</title>
   <style>
       :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
       body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; color:#333; }
       .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; position: relative; }
       .designer-credit { position: absolute; top: 12px; left: 20px; font-size: 10px; color: #bbb; font-weight: bold; }
       
       /* â­ ç½®é ‚ API è¨­å®šå€ - é†’ç›®çš„é»ƒè‰² */
       .api-top-box { background:#fffbe6; border:2px solid #ffe58f; padding:15px; border-radius:18px; margin-bottom:20px; margin-top:15px; }
       .api-top-box label { color: #856404; font-size: 14px; display: block; margin-bottom: 8px; font-weight: bold; }
       .api-input { width:100%; padding:10px; border:1px solid #ffe58f; border-radius:10px; font-size:14px; box-sizing:border-box; }

       .ocr-upload-zone { background:#e6f7ff; border:2px dashed #91d5ff; padding:25px; border-radius:18px; text-align:center; margin-bottom:20px; cursor:pointer; }
       .ocr-status { font-size:13px; color:#0050b3; font-weight:bold; margin-top:10px; display:block; }
       .input-group { margin-bottom:15px; }
       label { display:block; margin-bottom:6px; font-size:14px; font-weight:bold; color:#666; }
       input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; box-sizing:border-box; outline:none; }
       button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; margin-bottom:10px; }
       .btn-save { background:var(--success); color:white; }
       .btn-compare { background:var(--primary); color:white; }
       
       #comparison-area { margin-top:15px; display:none; }
       .compare-card { background:#f0f7ff; border:1px solid #cce5ff; border-radius:16px; padding:15px; }
       .compare-item { background:white; border-radius:10px; padding:10px; margin-bottom:8px; border-left:4px solid #ddd; position:relative; }
       .compare-item.best-cp { border-left-color:var(--warning); background:#fffdf0; }
       .best-tag { position:absolute; right:10px; top:10px; background:var(--warning); color:#856404; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
       
       .tab-controls { display:flex; gap:8px; margin-bottom:10px; justify-content: flex-end; }
       .tab-headers { display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; scrollbar-width:none; }
       .tab-btn { background:#eee; padding:10px 16px; border-radius:20px; white-space:nowrap; font-size:13px; font-weight:bold; flex-shrink:0; cursor:pointer; }
       .tab-btn.active { background:var(--primary); color:white; }
       .record-item { background:#fff; padding:14px; border-radius:14px; margin-bottom:10px; border:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
       .record-price { text-align:right; font-weight:800; color:var(--primary); font-size:18px; }
       .action-link { font-size:12px; color:var(--primary); margin-right:12px; cursor:pointer; font-weight: bold; }
       .action-link.delete { color:var(--danger); }
       .ctrl-mini-btn { font-size:11px; padding:5px 10px; border-radius:8px; background:#f0f0f0; border:1px solid #ddd; }
   </style>
</head>
<body>
<div class="container">
   <div class="designer-credit">è¨­è¨ˆè€…ï¼šLai Ade</div>
   <h2 style="text-align:center; margin:10px 0 10px 0; color:var(--primary);">ğŸ›’ æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹ V4.1</h2>

   <div class="api-top-box">
       <label>ğŸ”‘ ç¬¬ä¸€æ­¥ï¼šè«‹å¡«å…¥æ‚¨çš„ Gemini API Key</label>
       <input type="password" id="apiKey" class="api-input" placeholder="è«‹è²¼ä¸Šä»¥ AIza... é–‹é ­çš„é‡‘é‘°" onchange="saveApiKey(this.value)">
       <p style="color:#b29200; font-size:11px; margin-top:5px; margin-bottom:0;">* è²¼ä¸Šå¾Œé»æ“Šæ—é‚Šç©ºç™½è™•å³è‡ªå‹•å„²å­˜ï¼Œç³»çµ±æœƒè¨˜ä½æ­¤ Key</p>
   </div>
    
   <div class="ocr-upload-zone" id="ocrTrigger">
       <span style="font-size:35px;">ğŸ“¸</span>
       <p style="margin:5px 0; font-weight:bold;">ç¬¬äºŒæ­¥ï¼šæ‹æ”åƒ¹æ ¼ç‰Œ</p>
       <input type="file" id="ocr-upload" accept="image/*" style="display:none">
       <span id="ocr-status" class="ocr-status">ç­‰å¾… API Key...</span>
   </div>

   <div class="input-group"><label>ğŸª å•†åº—åç¨±</label><input type="text" id="storeName" placeholder="ä¾‹å¦‚ï¼šå…¨è¯ã€å¥½å¸‚å¤š"></div>
   <div class="input-group"><label>ğŸ“¦ å•†å“åç¨±</label><input type="text" id="itemName" placeholder="AI å°‡è‡ªå‹•è¾¨è­˜ä¸¦å¡«å…¥"></div>
   <div style="display:flex; gap:10px;">
       <div class="input-group" style="flex:1.5;"><label>ğŸ’µ ç¸½åƒ¹ (å…ƒ)</label><input type="number" id="price" inputmode="decimal" placeholder="0" oninput="updateLivePrice()"></div>
       <div class="input-group" style="flex:1;"><label>ğŸ”¢ æ•¸é‡</label><input type="number" id="count" value="1" inputmode="numeric" oninput="updateLivePrice()"></div>
       <div class="input-group" style="flex:1;"><label>ğŸ“ å–®ä½</label><select id="unitSelect" onchange="handleUnitChange(this); updateLivePrice();"></select></div>
   </div>
   <div class="input-group"><label>ğŸ“ å‚™è¨»æ¬„</label><input type="text" id="remark" placeholder="è²·ä¸€é€ä¸€ç­‰"></div>
   
   <button class="btn-save" id="btnSave">âœ… å„²å­˜æ­¤ç´€éŒ„</button>
   <button class="btn-compare" id="btnCompare">ğŸ” æ­·å²æ¯”åƒ¹ (CPå€¼)</button>
   
   <div id="comparison-area"><div class="compare-card">
       <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
           <h4 style="margin:0; color:#0056b3;">ğŸ“Š AI æ­·å²åˆ†æ</h4>
           <span id="closeCompare" style="font-size:20px; cursor:pointer;">Ã—</span>
       </div>
       <div id="compareList"></div>
   </div></div>

   <div id="store-tabs-container">
       <div id="tab-controls" class="tab-controls"></div>
       <div id="tab-headers" class="tab-headers"></div>
       <div id="tab-contents"></div>
   </div>

   <button id="btnClearAll" style="background:none; color:#999; font-size:11px; margin-top:20px; text-decoration:underline; border:none; width:auto; display:block; margin: 20px auto 0 auto;">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
</div>

<script>
let storeData = {}; let unitList = []; let editingIndex = null;
const DEFAULT_UNITS = ["å…¥","é¡†","å€‹","å…‹","æ¯«å‡","åŒ…","è¢‹","ç“¶","å…¬å‡"];

function saveApiKey(key){ 
    if(key.startsWith("Alza")) { key = "AIza" + key.substring(4); } // è‡ªå‹•ä¿®å¾© Alza éŒ¯èª¤
    localStorage.setItem('gemini_api_key', key.trim()); 
    document.getElementById('ocr-status').innerText = "âœ… API Key å·²å°±ç·’ï¼Œå¯ä»¥æ‹ç…§ï¼";
    alert("API Key å·²æˆåŠŸå„²å­˜ï¼"); 
}

async function performOCR(input) {
   const file = input.files[0]; if (!file) return;
   const apiKey = localStorage.getItem('gemini_api_key');
   if (!apiKey) { alert("âŒ è«‹å…ˆåœ¨ä¸Šæ–¹å¡«å…¥ API Keyï¼"); return; }

   const status = document.getElementById('ocr-status');
   status.innerText = "ğŸ§  AI è¦–è¦ºåˆ†æä¸­...";

   try {
       const base64Data = await new Promise(r => { const f=new FileReader(); f.onload=()=>r(f.result); f.readAsDataURL(file); });
       const base64Image = base64Data.split(',')[1];

       const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
               contents: [{ parts: [
                   { text: "ä½ æ˜¯è¶…å¸‚å°ˆå®¶ã€‚è®€å–åœ–ç‰‡ä¸¦å›å‚³ JSONï¼š{ 'item': 'å“å', 'price': æ•¸å­— }ã€‚åªå›å‚³ JSONã€‚" },
                   { inline_data: { mime_type: "image/jpeg", data: base64Image } }
               ]}]
           })
       });

       const result = await response.json();
       const aiText = result.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
       const data = JSON.parse(aiText);

       document.getElementById('itemName').value = data.item;
       document.getElementById('price').value = data.price;
       status.innerText = "âœ… è¾¨è­˜å®Œæˆ";
       updateLivePrice();
   } catch(e){ status.innerText="âŒ å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯"; console.error(e); }
}

// å…¶é¤˜åŠŸèƒ½ç¶­æŒ V3.6.1 ç©©å®šç‰ˆ
function updateLivePrice() {
   const p = parseFloat(document.getElementById('price').value) || 0;
   const c = parseFloat(document.getElementById('count').value) || 1;
   const u = document.getElementById('unitSelect').value;
   if (p > 0) document.getElementById('ocr-status').innerText = `ğŸ’¡ å–®åƒ¹ï¼š$${(p/c).toFixed(2)} / ${u}`;
}

function saveRecord() {
   const store=document.getElementById('storeName').value.trim()||"æœªåˆ†é¡å•†åº—";
   const name=document.getElementById('itemName').value.trim();
   const price=parseFloat(document.getElementById('price').value);
   const count=parseInt(document.getElementById('count').value)||1;
   const unit=document.getElementById('unitSelect').value;
   if(!name||isNaN(price)) return alert("è«‹è¼¸å…¥æ­£ç¢ºå“åèˆ‡åƒ¹æ ¼");
   if(!storeData[store]) storeData[store]=[];
   storeData[store].push({name,price,count,unit,date:new Date().toLocaleDateString()});
   localStorage.setItem('storeTabsData',JSON.stringify(storeData));
   renderTabs(store); resetInputs();
}

function renderTabs(activeStore=null){
   const headers = document.getElementById('tab-headers'), contents = document.getElementById('tab-contents');
   const storeNames = Object.keys(storeData);
   if(storeNames.length === 0){ contents.innerHTML = '<p style="text-align:center;color:#ccc;">å°šç„¡ç´€éŒ„</p>'; return; }
   if(!activeStore) activeStore = storeNames[storeNames.length-1];
   headers.innerHTML = storeNames.map(n => `<div class="tab-btn ${n === activeStore ? 'active' : ''}" onclick="renderTabs('${n}')">${n}</div>`).join('');
   const records = storeData[activeStore] || [];
   contents.innerHTML = records.slice().reverse().map((r, i) => `
       <div class="record-item">
           <div><b>${r.name}</b><br><small>${r.date} Â· ${r.count}${r.unit}</small></div>
           <div class="record-price">$${r.price}</div>
       </div>`).join('');
}

function refreshUnitSelect(target = "å…¥") {
   document.getElementById('unitSelect').innerHTML = DEFAULT_UNITS.map(u => `<option value="${u}" ${u===target?'selected':''}>${u}</option>`).join('') + '<option value="ADD_NEW">â• æ–°å¢...</option>';
}
function handleUnitChange(sel) { if(sel.value==="ADD_NEW"){ const n=prompt("è¼¸å…¥æ–°å–®ä½:"); if(n) refreshUnitSelect(n); } }
function resetInputs(){ document.getElementById('itemName').value=''; document.getElementById('price').value=''; }

window.onload=()=>{
   storeData=JSON.parse(localStorage.getItem('storeTabsData'))||{};
   const savedKey = localStorage.getItem('gemini_api_key');
   if(savedKey) { document.getElementById('apiKey').value = savedKey; document.getElementById('ocr-status').innerText = "âœ… API Key å·²å°±ç·’"; }
   document.getElementById('ocrTrigger').onclick=()=>document.getElementById('ocr-upload').click();
   document.getElementById('ocr-upload').onchange=e=>performOCR(e.target);
   document.getElementById('btnSave').onclick=saveRecord;
   document.getElementById('closeCompare').onclick=()=>document.getElementById('comparison-area').style.display='none';
   document.getElementById('btnClearAll').onclick=()=>{if(confirm("æ¸…ç©ºï¼Ÿ")){localStorage.clear(); location.reload();}};
   refreshUnitSelect(); renderTabs();
};
</script>
</body>
</html>
