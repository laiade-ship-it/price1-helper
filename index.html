<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ - V3.8 ğŸ”’</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; }
        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); position: relative; }
        .designer-credit { position: absolute; top: 12px; left: 20px; font-size: 10px; color: #bbb; font-weight: bold; letter-spacing: 0.5px; }
        .ocr-upload-zone { background:#fffbe6; border:2px dashed #ffe58f; padding:25px; border-radius:18px; text-align:center; margin-bottom:20px; cursor:pointer; margin-top: 15px; }
        .ocr-status { font-size:12px; color:#856404; font-weight:bold; margin-top:10px; display:block; }
        .input-group { margin-bottom:15px; }
        label { display:block; margin-bottom:6px; font-size:13px; font-weight:bold; color:#666; }
        input { width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; box-sizing:border-box; }
        button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; margin-bottom:10px; }
        .btn-save { background:var(--success); color:white; }
        #store-tabs-container { margin-top:25px; border-top:2px solid #f0f0f0; }
        .record-item { background:#fff; padding:12px; border-radius:12px; margin-bottom:8px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    </style>
</head>
<body>
<div class="container">
    <div class="designer-credit">è¨­è¨ˆè€…ï¼šLai Ade</div>
    <h2 style="text-align:center; color:var(--primary); margin-bottom:25px;">ğŸ›’ æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹ V3.8</h2>
    
    <div class="ocr-upload-zone" id="ocrTrigger">
        <span style="font-size:30px;">ğŸ“¸</span>
        <p style="margin:5px 0;">æ‹æ”åƒ¹æ ¼ç‰Œ</p>
        <input type="file" id="ocr-upload" accept="image/*" style="display:none">
        <span id="ocr-status" class="ocr-status">ç­‰å¾…æŒ‡ä»¤...</span>
    </div>

    <div class="input-group">
        <label>ğŸ“¦ è¾¨è­˜å•†å“åç¨±</label>
        <input type="text" id="itemName" placeholder="è‡ªå‹•ç¯©é¸ä¸­...">
    </div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1.5;">
            <label>ğŸ’µ è¾¨è­˜ä¸»åƒ¹æ ¼</label>
            <input type="number" id="price" placeholder="0">
        </div>
        <div class="input-group" style="flex:1;">
            <label>ğŸ”¢ æ•¸é‡</label>
            <input type="number" id="count" value="1">
        </div>
    </div>

    <button class="btn-save" id="btnSave">âœ… å„²å­˜ç´€éŒ„</button>
    
    <div id="store-tabs-container">
        <div id="tab-contents"></div>
    </div>
</div>

<script>
/**
 * ğŸ› ï¸ ç¬¬ä¸€å±¤ï¼šDeterministic Filter (ç¡¬éæ¿¾ç¨‹å¼ç¢¼)
 * è²¬ä»»ï¼šåœ¨äº¤çµ¦ AI ä¹‹å‰ï¼Œå…ˆç æ‰çµ•å°ä¸å¯èƒ½çš„é¸é …
 */
function deterministicFilter(ocrLines) {
    const BLACKLIST_KEYWORDS = ["/", "æ¯", "å¹³å‡", "å–®ä½åƒ¹", "åŸåƒ¹", "å»ºè­°å”®åƒ¹", "BCAA", "g", "ml", "PC"];
    let priceCandidates = [];
    let nameCandidates = [];

    ocrLines.forEach((line, index) => {
        const cleanLine = line.trim();
        
        // 1. åƒ¹æ ¼ç¡¬éæ¿¾ï¼šæ‰¾å‡ºæ•¸å­—
        const numbers = cleanLine.match(/\d+/g);
        if (numbers) {
            numbers.forEach(numStr => {
                const val = parseInt(numStr);
                if (val > 10) { // æ’é™¤éå°çš„é›œè¨Šæ•¸å­—
                    let isBlacklisted = BLACKLIST_KEYWORDS.some(k => cleanLine.includes(k));
                    if (!isBlacklisted) {
                        priceCandidates.push({ val: val, raw: cleanLine, index: index });
                    }
                }
            });
        }

        // 2. åç¨±å€™é¸ï¼šæ’é™¤ç´”æ•¸å­—èˆ‡é»‘åå–®
        if (!/^\d+$/.test(cleanLine) && cleanLine.length > 2 && !BLACKLIST_KEYWORDS.some(k => cleanLine.includes(k))) {
            nameCandidates.push({ text: cleanLine, index: index });
        }
    });

    return { nameCandidates, priceCandidates };
}

/**
 * ğŸ¤– ç¬¬äºŒå±¤ï¼šSelection-Only Engine (GEMINI æ ¸å¿ƒé‚è¼¯é æ¼”)
 * è²¬ä»»ï¼šå¾æ¸…å–®ä¸­é¸å‡ºå”¯ä¸€è§£ï¼Œä¸ç¢ºå®šå°± null
 */
async function performOCR(input) {
    if (!input.files[0]) return;
    const status = document.getElementById('ocr-status');
    status.innerText = "â³ åŸ·è¡Œè¡Œç‚ºæ”¶æ–‚å·¥ç¨‹...";
    
    let worker;
    try {
        worker = await Tesseract.createWorker('chi_tra+eng');
        const { data } = await worker.recognize(input.files[0]);
        const lines = (data.lines || []).map(l => l.text.trim()).filter(Boolean);

        // --- åŸ·è¡Œç¡¬éæ¿¾ ---
        const filtered = deterministicFilter(lines);

        // --- æ¨¡æ“¬ AI é¸æ“‡é‚è¼¯ (é€™éƒ¨åˆ†åœ¨ V3.8 ä¸­ç›´æ¥ç”± JS æ ¹æ“šæœ€åš´è¦å‰‡åŸ·è¡Œ) ---
        let finalPrice = null;
        let finalName = null;

        // è¦å‰‡ï¼šå¦‚æœåƒ¹æ ¼å€™é¸åªæœ‰ä¸€å€‹ï¼Œæˆ–æŸå€‹å«è²¨å¹£å–®ä½ï¼Œå‰‡é¸ä¹‹
        if (filtered.priceCandidates.length > 0) {
            // å„ªå…ˆæ‰¾å«ã€Œ$ã€æˆ–ã€Œå…ƒã€çš„
            const currencyMatch = filtered.priceCandidates.find(p => /[\$å…ƒ]/.test(p.raw));
            finalPrice = currencyMatch ? currencyMatch.val : filtered.priceCandidates[0].val;
            
            // å¦‚æœåŒæ™‚å‡ºç¾å¤šå€‹è£¸æ•¸å­—ä¸”ç„¡æ³•åˆ¤å®šï¼Œå‰‡è‡ªæ¯€
            if (filtered.priceCandidates.length > 1 && !currencyMatch) finalPrice = null;
        }

        // è¦å‰‡ï¼šé¸æœ€é è¿‘åƒ¹æ ¼ä¸Šæ–¹çš„åç¨±
        if (filtered.nameCandidates.length > 0) {
            finalName = filtered.nameCandidates[0].text;
        }

        // --- å¡«å…¥ä»‹é¢ ---
        document.getElementById('itemName').value = finalName || "";
        document.getElementById('price').value = finalPrice || "";
        
        status.innerText = finalPrice ? "âœ… ç©©å®šè¾¨è­˜å®Œæˆ" : "âš ï¸ æ•¸æ“šæ¨¡ç³Šï¼Œè«‹æ‰‹å‹•æ ¡å°";
        
    } catch(e) { status.innerText="âŒ ç³»çµ±éŒ¯èª¤"; } finally { if(worker) await worker.terminate(); }
}

// åŸºæœ¬ UI åˆå§‹åŒ–
window.onload=()=>{
    document.getElementById('ocrTrigger').onclick=()=>document.getElementById('ocr-upload').click();
    document.getElementById('ocr-upload').onchange=e=>performOCR(e.target);
};
</script>
</body>
</html>
