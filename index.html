<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¯”åƒ¹åŠ©æ‰‹">
    
    <title>æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹ V3.7.0 - å¤§å®¹é‡ç‰ˆ ğŸ”’</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding: env(safe-area-inset-top) 15px env(safe-area-inset-bottom) 15px; display:flex; justify-content:center; color:#333; }
        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; position: relative; }
        .designer-tag { position: absolute; top: 12px; left: 15px; font-size: 10px; color: #bbb; letter-spacing: 0.5px; }
        #compPanel { background: #fff7e6; border: 1px solid #ffd591; border-radius: 15px; padding: 12px; margin-bottom: 15px; display: none; }
        .comp-title { font-size: 13px; color: #d46b08; font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .comp-item { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; border-bottom: 1px dashed #ffd591; padding: 8px 4px; cursor: pointer; border-radius: 8px; }
        .comp-best { color: #cf1322; font-weight: 800; }
        .unit-price-box { background: #eef6ff; border: 1px solid #d0e7ff; padding: 12px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .unit-price-value { font-size: 20px; font-weight: 800; color: #0056b3; }
        .photo-upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .photo-slot { aspect-ratio: 1; border: 2px dashed #ddd; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; background: #fafafa; overflow: hidden; font-size: 24px; color: #ccc; }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        .photo-slot .remove-p { position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.7); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; text-align: center; line-height: 22px; z-index: 10; }
        .input-group { margin-bottom:12px; }
        label { display:block; margin-bottom:4px; font-size:13px; font-weight:bold; color:#666; }
        input, select, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:16px; box-sizing:border-box; outline:none; }
        textarea { height: 50px; resize: none; }
        button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; }
        .btn-save { background:var(--success); color:white; margin-top: 10px;}
        .tab-headers { display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        .tab-btn { background:#eee; padding:8px 16px; border-radius:20px; font-size:13px; cursor:pointer; font-weight:bold; white-space:nowrap; }
        .tab-btn.active { background:var(--primary); color:white; }
        .record-item { background:#fff; padding:15px; border-radius:16px; margin-bottom:12px; border:1px solid #eee; transition: 0.3s; }
        .record-photos { display: flex; gap: 8px; margin-top: 10px; }
        .record-photos img { width: 65px; height: 65px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; }
        .highlight-record { background: #fffbe6 !important; border: 2px solid var(--warning) !important; transform: scale(1.02); }
        .record-memo { background: #fdfdfd; border-left: 3px solid #ddd; padding: 5px 10px; margin: 8px 0; font-size: 13px; color: #777; }
        .action-links { margin-top: 12px; padding-top: 10px; border-top: 1px dashed #eee; display: flex; gap: 15px; }
        .btn-edit { color: var(--primary); cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-delete { color: var(--danger); cursor: pointer; font-size: 13px; }
        #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        #lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .close-zoom { position: absolute; top: 40px; right: 20px; color: white; font-size: 30px; background: rgba(255,255,255,0.2); width: 44px; height: 44px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .tab-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .action-small { font-size: 12px; cursor: pointer; font-weight: bold; padding: 5px 10px; border-radius: 8px; }
        .btn-rename { color: var(--primary); background: #e6f7ff; }
        .btn-del-store { color: var(--danger); background: #fff1f0; }
    </style>
</head>
<body>

<div id="lightbox" onclick="closeLightbox()">
    <div class="close-zoom">Ã—</div>
    <img id="lightbox-img" src="" onclick="event.stopPropagation()">
</div>

<div class="container">
    <div class="designer-tag">è¨­è¨ˆè€…ï¼šLai Ade | V3.7.0 (å¤§å®¹é‡)</div>
    <h2 style="text-align:center; color:var(--primary); margin:10px 0 15px 0;">ğŸ›’ æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹</h2>

    <div id="compPanel">
        <div class="comp-title">ğŸ” æ­·å²æ¯”åƒ¹ (é»æ“Šè·³è½‰)ï¼š<span>âš¡ å¿«æœ</span></div>
        <div id="compList"></div>
    </div>

    <div class="unit-price-box">
        <div style="font-size:12px; color:#666;">ğŸ’¡ æ›ç®—å–®åƒ¹</div>
        <div class="unit-price-value" id="calcResult">-- / å–®ä½</div>
    </div>

    <div class="photo-upload-grid">
        <div class="photo-slot" onclick="triggerFile(0)" id="slot-0">+</div>
        <div class="photo-slot" onclick="triggerFile(1)" id="slot-1">+</div>
        <div class="photo-slot" onclick="triggerFile(2)" id="slot-2">+</div>
    </div>
    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">

    <div class="input-group"><label>ğŸ“¦ å•†å“åç¨±</label><input type="text" id="itemName" oninput="liveCompare()" placeholder="æœå°‹æ­·å²ç´€éŒ„"></div>
    <div class="input-group"><label>ğŸª å•†åº—åç¨±</label><input type="text" id="storeName" placeholder="ä¾‹å¦‚ï¼šå…¨è¯"></div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1.5;"><label>ğŸ’µ ç¸½åƒ¹</label><input type="number" id="price" oninput="updateCalculation()" inputmode="decimal"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ”¢ æ•¸é‡</label><input type="number" id="count" value="1" oninput="updateCalculation()" inputmode="decimal"></div>
        <div class="input-group" style="flex:1.2;"><label>ğŸ“ å–®ä½</label><select id="unitSelect" onchange="handleUnitChange(this); updateCalculation()"></select></div>
    </div>

    <div class="input-group"><label>ğŸ“… è³¼è²·æ—¥æœŸ</label><input type="date" id="purchaseDate"></div>
    <div class="input-group"><label>ğŸ“ å‚™è¨»</label><textarea id="itemMemo"></textarea></div>

    <button class="btn-save" id="btnSave" onclick="saveRecord()">âœ… å„²å­˜æ­¤ç´€éŒ„</button>

    <div id="tab-controls" class="tab-actions" style="display:none;">
        <span id="renameStoreBtn" class="action-small btn-rename">âœï¸ é‡æ–°å‘½åå•†åº—</span>
        <span id="delStoreBtn" class="action-small btn-del-store">ğŸ—‘ï¸ åˆªé™¤å•†åº—</span>
    </div>
    
    <div id="tab-headers" class="tab-headers"></div>
    <div id="tab-contents"></div>
</div>

<script>
// --- ğŸ—„ï¸ IndexedDB å¼•æ“è¨­å®š ---
const DB_NAME = "PriceAssistantDB";
const STORE_NAME = "Settings";
let storeData = {}; 
let unitList = [];
let currentPhotos = [null, null, null];
let editingTarget = null;
let currentSlotIndex = 0;
const DEFAULT_UNITS = ["å…¥","å€‹","å…‹(g)","æ¯«å‡(ml)","åŒ…","ç“¶","å…¬å‡(L)"];

// åˆå§‹åŒ–è³‡æ–™åº«
function initDB() {
    return new Promise((resolve) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
            }
        };
        request.onsuccess = (e) => resolve(e.target.result);
    });
}

async function dbGetData(key) {
    const db = await initDB();
    return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const request = store.get(key);
        request.onsuccess = () => resolve(request.result);
    });
}

async function dbSaveData(key, value) {
    const db = await initDB();
    const tx = db.transaction(STORE_NAME, "readwrite");
    tx.objectStore(STORE_NAME).put(value, key);
}

// --- ğŸš€ è‡ªå‹•æ¬å®¶é‚è¼¯ï¼šLocalStorage -> IndexedDB ---
async function migrateData() {
    const oldStoreData = localStorage.getItem('storeTabsData');
    const oldUnits = localStorage.getItem('managedUnits');
    
    if (oldStoreData) {
        await dbSaveData('storeTabsData', JSON.parse(oldStoreData));
        localStorage.removeItem('storeTabsData');
        console.log("å•†åº—ç´€éŒ„æ¬å®¶æˆåŠŸ");
    }
    if (oldUnits) {
        await dbSaveData('managedUnits', JSON.parse(oldUnits));
        localStorage.removeItem('managedUnits');
    }
}

// --- âš¡ æ ¸å¿ƒæ¯”åƒ¹é‚è¼¯ ---
function liveCompare() {
    const name = document.getElementById('itemName').value.trim();
    const panel = document.getElementById('compPanel');
    const list = document.getElementById('compList');
    if (name.length < 1) { panel.style.display = 'none'; return; }
    let matches = [];
    Object.keys(storeData).forEach(store => {
        storeData[store].forEach((item, idx) => {
            if (item.name.toLowerCase().includes(name.toLowerCase())) {
                matches.push({ store, ...item, originalIdx: idx });
            }
        });
    });
    if (matches.length > 0) {
        matches.sort((a, b) => a.unitPrice - b.unitPrice);
        panel.style.display = 'block';
        list.innerHTML = matches.slice(0, 3).map((m, i) => `
            <div class="comp-item" onclick="jumpToRecord('${m.store}', ${m.originalIdx})">
                <span><b>${m.store}</b> - ${m.name.substring(0,10)}</span>
                <span class="${i===0?'comp-best':''}">$${m.unitPrice}/${m.unit} â”</span>
            </div>
        `).join('');
    } else { panel.style.display = 'none'; }
}

function jumpToRecord(store, idx) {
    renderTabs(store);
    setTimeout(() => {
        const targetId = `record-${store}-${idx}`;
        const element = document.getElementById(targetId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            element.classList.add('highlight-record');
            setTimeout(() => element.classList.remove('highlight-record'), 2000);
        }
    }, 300);
}

// --- ğŸ“¸ åœ–ç‰‡è™•ç† ---
function openLightbox(src) {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}
function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; document.body.style.overflow = ''; }
function triggerFile(index) { currentSlotIndex = index; document.getElementById('file-input').click(); }

async function handleFile(input) {
    if (!input.files[0]) return;
    const base64 = await compressImage(input.files[0]);
    currentPhotos[currentSlotIndex] = base64;
    renderPhotoSlots();
    if(currentSlotIndex === 0) performOCR(input.files[0]);
    input.value = "";
}

function compressImage(file) {
    return new Promise(res => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const max = 800;
                let w = img.width, h = img.height;
                if (w > h) { if(w > max){ h *= max/w; w = max; } } else { if(h > max){ w *= max/h; h = max; } }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                res(canvas.toDataURL('image/jpeg', 0.7));
            };
        };
    });
}

function renderPhotoSlots() {
    currentPhotos.forEach((data, i) => {
        document.getElementById(`slot-${i}`).innerHTML = data ? `<img src="${data}"><div class="remove-p" onclick="event.stopPropagation();currentPhotos[${i}]=null;renderPhotoSlots()">Ã—</div>` : `+`;
    });
}

async function performOCR(file) {
    const worker = await Tesseract.createWorker('chi_tra');
    const { data: { text } } = await worker.recognize(file);
    const cleanText = text.split('\n')[0].replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').trim();
    if(cleanText) document.getElementById('itemName').value = cleanText;
    liveCompare();
    await worker.terminate();
}

// --- ğŸ’¾ æ•¸æ“šå­˜å– ---
async function saveRecord() {
    const store = document.getElementById('storeName').value.trim() || "æœªåˆ†é¡";
    const name = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const count = parseFloat(document.getElementById('count').value) || 1;
    const unit = document.getElementById('unitSelect').value;
    const memo = document.getElementById('itemMemo').value.trim();
    const date = document.getElementById('purchaseDate').value;

    if (!name || isNaN(price)) return alert("è«‹å¡«å¯«å“åèˆ‡åƒ¹æ ¼");
    
    if (editingTarget) {
        storeData[editingTarget.store].splice(editingTarget.index, 1);
        if (storeData[editingTarget.store].length === 0) delete storeData[editingTarget.store];
    }
    
    if (!storeData[store]) storeData[store] = [];
    storeData[store].push({
        name, price, count, unit, memo,
        unitPrice: (price / count).toFixed(2),
        photos: currentPhotos.filter(p => p !== null),
        date: date
    });
    
    await dbSaveData('storeTabsData', storeData);
    editingTarget = null;
    currentPhotos = [null, null, null];
    renderPhotoSlots(); resetForm(); renderTabs(store);
}

function renderTabs(activeStore = null) {
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    const ctrl = document.getElementById('tab-controls');
    const stores = Object.keys(storeData);
    if (stores.length === 0) { headers.innerHTML = ""; contents.innerHTML = "å°šç„¡ç´€éŒ„"; ctrl.style.display="none"; return; }
    
    const currentStore = activeStore || stores[0];
    ctrl.style.display = "flex";
    document.getElementById('delStoreBtn').onclick = () => deleteStore(currentStore);
    document.getElementById('renameStoreBtn').onclick = () => renameStore(currentStore);
    
    headers.innerHTML = stores.map(s => `<div class="tab-btn ${s===currentStore?'active':''}" onclick="renderTabs('${s}')">${s}</div>`).join('');
    
    contents.innerHTML = storeData[currentStore].slice().reverse().map((r, i) => {
        const actualIdx = storeData[currentStore].length - 1 - i;
        return `
        <div class="record-item" id="record-${currentStore}-${actualIdx}">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <b style="flex:1">${r.name}</b>
                <span style="color:var(--primary); font-weight:bold; text-align:right;">$${r.price}<br><small style="color:#999">($${r.unitPrice}/${r.unit})</small></span>
            </div>
            <div style="font-size:11px; color:#aaa; margin: 4px 0;">ğŸ“… æ—¥æœŸï¼š${r.date || 'æœªæ¨™è¨˜'}</div>
            ${r.memo ? `<div class="record-memo">${r.memo}</div>` : ''}
            <div class="record-photos">${r.photos.map(p => `<img src="${p}" onclick="openLightbox('${p}')">`).join('')}</div>
            <div class="action-links">
                <span class="btn-edit" onclick="editItem('${currentStore}', ${actualIdx})">âœï¸ ç·¨è¼¯</span>
                <span class="btn-delete" onclick="deleteItem('${currentStore}', ${actualIdx})">ğŸ—‘ï¸ åˆªé™¤</span>
            </div>
        </div>`}).join('');
}

async function renameStore(oldName) {
    const newName = prompt("è«‹è¼¸å…¥æ–°çš„å•†åº—åç¨±ï¼š", oldName);
    if (!newName || newName.trim() === "" || newName === oldName) return;
    if (storeData[newName.trim()]) return alert("è©²å•†åº—åç¨±å·²å­˜åœ¨ï¼");
    storeData[newName.trim()] = storeData[oldName];
    delete storeData[oldName];
    await dbSaveData('storeTabsData', storeData);
    renderTabs(newName.trim());
}

async function deleteStore(store) { if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${store}ã€ï¼Ÿ`)) { delete storeData[store]; await dbSaveData('storeTabsData', storeData); renderTabs(); } }
async function deleteItem(store, index) { if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { storeData[store].splice(index, 1); if (storeData[store].length === 0) delete storeData[store]; await dbSaveData('storeTabsData', storeData); renderTabs(); } }

function editItem(store, index) {
    const item = storeData[store][index];
    document.getElementById('storeName').value = store;
    document.getElementById('itemName').value = item.name;
    document.getElementById('price').value = item.price;
    document.getElementById('count').value = item.count;
    document.getElementById('itemMemo').value = item.memo || "";
    document.getElementById('purchaseDate').value = item.date || "";
    refreshUnitSelect(item.unit);
    currentPhotos = [null, null, null];
    if (item.photos) item.photos.forEach((p, i) => currentPhotos[i] = p);
    renderPhotoSlots();
    editingTarget = { store, index };
    document.getElementById('btnSave').innerText = "ğŸ†™ æ›´æ–°ç´€éŒ„";
    document.getElementById('btnSave').style.background = "var(--primary)";
    updateCalculation(); window.scrollTo({top: 0, behavior: 'smooth'});
}

function updateCalculation() {
    const p = parseFloat(document.getElementById('price').value) || 0;
    const c = parseFloat(document.getElementById('count').value) || 1;
    const u = document.getElementById('unitSelect').value;
    document.getElementById('calcResult').innerText = p > 0 ? `$${(p/c).toFixed(2)} / ${u}` : `-- / å–®ä½`;
}

function refreshUnitSelect(target=null) {
    const sel = document.getElementById('unitSelect');
    const combined = Array.from(new Set([...DEFAULT_UNITS, ...unitList]));
    sel.innerHTML = combined.map(u => `<option value="${u}" ${u===target?'selected':''}>${u}</option>`).join('') + `<option value="ADD_NEW">â• æ–°å¢</option>`;
}

function handleUnitChange(sel) { if(sel.value==="ADD_NEW"){ const n=prompt("æ–°å–®ä½:"); if(n){ unitList.push(n); dbSaveData('managedUnits', unitList); refreshUnitSelect(n); } } }

function resetForm() {
    document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('itemName').value = ""; document.getElementById('price').value = "";
    document.getElementById('count').value = "1"; document.getElementById('itemMemo').value = "";
    document.getElementById('btnSave').innerText = "âœ… å„²å­˜æ­¤ç´€éŒ„";
    document.getElementById('btnSave').style.background = "var(--success)";
    document.getElementById('compPanel').style.display = 'none';
}

window.onload = async () => {
    await migrateData(); // æ¬å®¶
    storeData = await dbGetData('storeTabsData') || {};
    unitList = await dbGetData('managedUnits') || [];
    refreshUnitSelect(); 
    resetForm();
    renderTabs();
};
</script>
</body>
</html>
