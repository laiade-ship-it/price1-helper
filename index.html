<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“æ¯”åƒ¹åŠ©æ‰‹ V3.6.1 - å°ˆæ¥­ç‰ˆ</title>
    <style>
        :root {
            --bg: #f5f7f9; --text: #333; --card: #fff; --primary: #007bff;
            --success: #28a745; --danger: #dc3545; --border: #dee2e6;
        }
        body.dark-mode {
            --bg: #121212; --text: #e0e0e0; --card: #1e1e1e; --border: #333;
        }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 15px; transition: 0.3s; }
        .container { max-width: 900px; margin: auto; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* è¼¸å…¥é¢æ¿ */
        .input-panel {
            background: var(--card); padding: 20px; border-radius: 12px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        input { padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); }
        
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add { background: var(--primary); color: white; grid-column: span 1; }
        .btn-theme { background: #6c757d; color: white; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { background: var(--card); border-radius: 12px; overflow-x: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: rgba(0,0,0,0.03); font-size: 0.9rem; }
        
        .highlight-best { background: rgba(40, 167, 69, 0.15); color: var(--success); font-weight: bold; }
        .unit-price-tag { color: var(--danger); font-weight: bold; }
        .delete-btn { color: var(--danger); cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“Š æ¯”åƒ¹åŠ©æ‰‹ <small>V3.6.1</small></h1>
        <button class="btn-theme" id="themeBtn">åˆ‡æ›æ¨¡å¼é è¦½</button>
    </header>

    <div class="input-panel">
        <div class="input-group">
            <label>å•†å“åç¨±</label>
            <input type="text" id="pName" placeholder="ä¾‹å¦‚ï¼šè¡›ç”Ÿç´™">
        </div>
        <div class="input-group">
            <label>å•†åº—/ä¾†æº</label>
            <input type="text" id="pShop" placeholder="ä¾‹å¦‚ï¼šå¥½å¸‚å¤š">
        </div>
        <div class="input-group">
            <label>ç¸½åƒ¹æ ¼ (TWD)</label>
            <input type="number" id="pPrice" placeholder="0">
        </div>
        <div class="input-group">
            <label>æ•¸é‡ (å¦‚:å…‹/æŠ½/å…¥)</label>
            <input type="number" id="pQty" placeholder="1">
        </div>
        <div class="input-group" style="justify-content: flex-end;">
            <button class="btn-add" id="addBtn">æ–°å¢æ¯”åƒ¹é …ç›®</button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>å•†å“</th>
                    <th>å•†åº—</th>
                    <th>è¦æ ¼æ•¸é‡</th>
                    <th>ç¸½åƒ¹</th>
                    <th>å–®ä½å”®åƒ¹ (â–¼)</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="dataBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    /** 1. IndexedDB æ ¸å¿ƒæ¨¡çµ„ **/
    const DB_NAME = 'PriceMasterV3';
    const STORE_NAME = 'records';

    function initDB() {
        return new Promise((resolve) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = (e) => {
                e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            };
            req.onsuccess = () => resolve(req.result);
        });
    }

    async function dbAction(type, data = null) {
        const db = await initDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        return new Promise((resolve) => {
            let req = (type === 'add') ? store.add(data) : (type === 'del') ? store.delete(data) : store.getAll();
            req.onsuccess = () => resolve(req.result);
        });
    }

    /** 2. UI é‚è¼¯èˆ‡è¨ˆç®— **/
    const dataBody = document.getElementById('dataBody');

    async function refreshUI() {
        let items = await dbAction('get');
        
        // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—å–®åƒ¹ä¸¦æ’åº
        // å–®åƒ¹ = ç¸½åƒ¹ / æ•¸é‡
        items = items.map(item => ({
            ...item,
            unitPrice: (item.price / item.qty).toFixed(4)
        })).sort((a, b) => a.unitPrice - b.unitPrice);

        const minUnitPrice = items.length > 0 ? Math.min(...items.map(i => i.unitPrice)) : 0;

        dataBody.innerHTML = items.map(item => `
            <tr class="${item.unitPrice == minUnitPrice && items.length > 1 ? 'highlight-best' : ''}">
                <td>${item.name}</td>
                <td>${item.shop}</td>
                <td>${item.qty}</td>
                <td>$${Number(item.price).toLocaleString()}</td>
                <td class="unit-price-tag">$${item.unitPrice}</td>
                <td><span class="delete-btn" onclick="removeItem(${item.id})">âŒ åˆªé™¤</span></td>
            </tr>
        `).join('');
    }

    document.getElementById('addBtn').addEventListener('click', async () => {
        const name = document.getElementById('pName').value || 'æœªå‘½åå•†å“';
        const shop = document.getElementById('pShop').value || 'æœªçŸ¥å•†åº—';
        const price = parseFloat(document.getElementById('pPrice').value);
        const qty = parseFloat(document.getElementById('pQty').value) || 1;

        if (isNaN(price)) return alert('è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼');

        await dbAction('add', { name, shop, price, qty, time: new Date() });
        // æ¸…ç©ºè¼¸å…¥
        ['pName', 'pShop', 'pPrice', 'pQty'].forEach(id => document.getElementById(id).value = '');
        refreshUI();
    });

    window.removeItem = async (id) => {
        if (confirm('ç¢ºå®šè¦ç§»é™¤æ­¤ç´€éŒ„ï¼Ÿ')) {
            await dbAction('del', id);
            refreshUI();
        }
    };

    /** 3. LocalStorage ä¸»é¡Œæ§åˆ¶ **/
    const themeBtn = document.getElementById('themeBtn');
    if (localStorage.getItem('v3_theme') === 'dark') document.body.classList.add('dark-mode');

    themeBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('v3_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });

    refreshUI();
</script>

</body>
</html>
