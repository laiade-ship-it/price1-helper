lines.forEach(line => {
    // 1. 定義語意標記
    const hasPriceSemantic = /([$¥]|NT\$|特價|售價|原價|金額|總計|Total)/i.test(line);
    const hasAttribute = /\d+\s?(ml|毫升|g|公克|克|kg|公斤|入|包|瓶|罐|oz|盎司|入組|x|X)/i.test(line);

    // --- 【二、強制實作】封鎖屬性主體行 ---
    // 規則：命中單位且無價格語意，該行直接剔除，不允許進入任何後續數字解析
    if (hasAttribute && !hasPriceSemantic) return; 

    let foundPrice = false;

    // --- 【三、不可違反】語意價格提取 ---
    if (hasPriceSemantic) {
        const semanticPriceRegex = /([$¥]|NT\$|價[:：])\s?(\d{1,5}(?:[.,]\d{1,2})?)/gi;
        let sMatch;
        while ((sMatch = semanticPriceRegex.exec(line)) !== null) {
            priceCandidates.push({ val: parseFloat(sMatch[2].replace(/,/g, '')), score: 300 });
            foundPrice = true;
        }

        // --- 【三、不可違反】限制級 Fallback ---
        // 條件：必須是價格行，且絕對不允許有屬性單位干擾
        if (!foundPrice && !hasAttribute) {
            const pureNumberRegex = /(?:\s|^)(\d{1,5})(?:\s|$)/g;
            let pMatch;
            while ((pMatch = pureNumberRegex.exec(line)) !== null) {
                if (pMatch[1].length <= 5) {
                    priceCandidates.push({ val: parseFloat(pMatch[1]), score: 100 });
                }
            }
        }
    }
    // 非價格語意行（!hasPriceSemantic）且非屬性行時，直接忽略，不執行數字提取
});
