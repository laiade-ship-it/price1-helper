<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹ V3.6.5 ğŸ”’</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; color:#333; }
        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; }
        
        /* âš¡ å³æ™‚æ¯”åƒ¹é¢æ¿æ¨£å¼ */
        #compPanel { background: #fff7e6; border: 1px solid #ffd591; border-radius: 15px; padding: 12px; margin-bottom: 15px; display: none; }
        .comp-title { font-size: 13px; color: #d46b08; font-weight: bold; margin-bottom: 8px; }
        .comp-item { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; border-bottom: 1px dashed #ffd591; padding-bottom: 3px; }
        .comp-best { color: #cf1322; font-weight: 800; }

        /* ğŸ“¸ ç…§ç‰‡å€ */
        .photo-upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .photo-slot { aspect-ratio: 1; border: 2px dashed #ddd; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; background: #fafafa; overflow: hidden; font-size: 24px; color: #ccc; }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        .photo-slot .remove-p { position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.7); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 14px; text-align: center; line-height: 20px; z-index: 10; }

        /* ğŸ’¡ è¨ˆç®—å€ */
        .unit-price-box { background: #eef6ff; border: 1px solid #d0e7ff; padding: 12px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .unit-price-value { font-size: 20px; font-weight: 800; color: #0056b3; }

        .input-group { margin-bottom:12px; }
        label { display:block; margin-bottom:4px; font-size:13px; font-weight:bold; color:#666; }
        input, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:15px; box-sizing:border-box; outline:none; }
        
        button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; }
        .btn-save { background:var(--success); color:white; margin-top: 10px;}

        /* ğŸ“ è³‡æ–™å¤¾å€åŸŸ */
        .tab-headers { display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        .tab-btn { background:#eee; padding:8px 16px; border-radius:20px; font-size:13px; cursor:pointer; font-weight:bold; white-space:nowrap; }
        .tab-btn.active { background:var(--primary); color:white; }
        
        .record-item { background:#fff; padding:15px; border-radius:16px; margin-bottom:12px; border:1px solid #eee; position: relative; }
        .record-photos { display: flex; gap: 8px; margin-top: 10px; }
        .record-photos img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; cursor: zoom-in; }
        
        .action-links { margin-top: 12px; padding-top: 10px; border-top: 1px dashed #eee; display: flex; gap: 15px; }
        .btn-edit { color: var(--primary); cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-delete { color: var(--danger); cursor: pointer; font-size: 13px; font-weight: bold; }

        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; }
        #lightbox img { max-width: 95%; max-height: 95%; }
    </style>
</head>
<body>

<div id="lightbox" onclick="this.style.display='none'"><img id="lightbox-img" src=""></div>

<div class="container">
    <h2 style="text-align:center; color:var(--primary); margin:0 0 15px 0;">ğŸ›’ æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹ V3.6.5</h2>

    <div id="compPanel">
        <div class="comp-title">ğŸ” æ­·å²æ¯”åƒ¹åƒè€ƒï¼š</div>
        <div id="compList"></div>
    </div>

    <div class="unit-price-box">
        <div style="font-size:12px; color:#666;">ğŸ’¡ æ›ç®—å–®åƒ¹</div>
        <div class="unit-price-value" id="calcResult">-- / å–®ä½</div>
    </div>

    <div class="photo-upload-grid">
        <div class="photo-slot" onclick="triggerFile(0)" id="slot-0">+</div>
        <div class="photo-slot" onclick="triggerFile(1)" id="slot-1">+</div>
        <div class="photo-slot" onclick="triggerFile(2)" id="slot-2">+</div>
    </div>
    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">

    <div class="input-group"><label>ğŸ“¦ å•†å“åç¨±</label><input type="text" id="itemName" oninput="liveCompare()" placeholder="è¼¸å…¥å“åè‡ªå‹•æ¯”åƒ¹"></div>
    <div class="input-group"><label>ğŸª å•†åº—åç¨±</label><input type="text" id="storeName" placeholder="å…¨è¯ã€å¥½å¸‚å¤š..."></div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1.5;"><label>ğŸ’µ ç¸½åƒ¹</label><input type="number" id="price" oninput="updateCalculation()" inputmode="decimal"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ”¢ æ•¸é‡</label><input type="number" id="count" value="1" oninput="updateCalculation()" inputmode="decimal"></div>
        <div class="input-group" style="flex:1.2;"><label>ğŸ“ å–®ä½</label><select id="unitSelect" onchange="handleUnitChange(this); updateCalculation()"></select></div>
    </div>

    <button class="btn-save" id="btnSave" onclick="saveRecord()">âœ… å„²å­˜æ­¤ç´€éŒ„</button>

    <div id="tab-controls" style="text-align:right; margin-top:15px; display:none;">
        <small id="delStoreBtn" style="color:var(--danger); cursor:pointer; font-weight:bold; background:#fff1f0; padding:4px 8px; border-radius:8px;">ğŸ—‘ï¸ åˆªé™¤æ•´å€‹å•†åº—</small>
    </div>
    <div id="tab-headers" class="tab-headers"></div>
    <div id="tab-contents"></div>
</div>

<script>
let storeData = {}; 
let unitList = [];
let currentPhotos = [null, null, null];
let editingTarget = null;
let currentSlotIndex = 0;
const DEFAULT_UNITS = ["å…¥","å€‹","å…‹(g)","æ¯«å‡(ml)","åŒ…","ç“¶","å…¬å‡(L)","å…¬æ–¤(kg)"];

// --- âš¡ æ ¸å¿ƒåŠŸèƒ½ï¼šå³æ™‚æ¯”åƒ¹ ---
function liveCompare() {
    const name = document.getElementById('itemName').value.trim();
    const panel = document.getElementById('compPanel');
    const list = document.getElementById('compList');
    
    if (name.length < 1) { panel.style.display = 'none'; return; }

    let matches = [];
    Object.keys(storeData).forEach(store => {
        storeData[store].forEach(item => {
            if (item.name.toLowerCase().includes(name.toLowerCase())) {
                matches.push({ store, ...item });
            }
        });
    });

    if (matches.length > 0) {
        matches.sort((a, b) => a.unitPrice - b.unitPrice);
        panel.style.display = 'block';
        list.innerHTML = matches.slice(0, 3).map((m, i) => `
            <div class="comp-item">
                <span><b>${m.store}</b> - ${m.name}</span>
                <span class="${i===0?'comp-best':''}">$${m.unitPrice} / ${m.unit}</span>
            </div>
        `).join('');
    } else {
        panel.style.display = 'none';
    }
}

// --- ğŸ“ æ ¸å¿ƒåŠŸèƒ½ï¼šå–®åƒ¹è¨ˆç®— ---
function updateCalculation() {
    const p = parseFloat(document.getElementById('price').value) || 0;
    const c = parseFloat(document.getElementById('count').value) || 1;
    const u = document.getElementById('unitSelect').value;
    document.getElementById('calcResult').innerText = p > 0 ? `$${(p/c).toFixed(2)} / ${u}` : `-- / å–®ä½`;
}

// --- ğŸ’¾ å„²å­˜èˆ‡åˆ†é  ---
function saveRecord() {
    const store = document.getElementById('storeName').value.trim() || "æœªåˆ†é¡";
    const name = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const count = parseFloat(document.getElementById('count').value) || 1;
    const unit = document.getElementById('unitSelect').value;

    if (!name || isNaN(price)) return alert("è«‹å¡«å¯«å“åèˆ‡åƒ¹æ ¼");

    if (editingTarget) {
        storeData[editingTarget.store].splice(editingTarget.index, 1);
        if (storeData[editingTarget.store].length === 0) delete storeData[editingTarget.store];
    }

    if (!storeData[store]) storeData[store] = [];
    storeData[store].push({
        name, price, count, unit,
        unitPrice: (price / count).toFixed(2),
        photos: currentPhotos.filter(p => p !== null),
        date: new Date().toLocaleDateString()
    });

    localStorage.setItem('storeTabsData', JSON.stringify(storeData));
    editingTarget = null;
    currentPhotos = [null, null, null];
    renderPhotoSlots();
    resetForm();
    renderTabs(store);
}

function renderTabs(activeStore = null) {
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    const ctrl = document.getElementById('tab-controls');
    const stores = Object.keys(storeData);

    if (stores.length === 0) {
        headers.innerHTML = ""; contents.innerHTML = "å°šç„¡ç´€éŒ„"; ctrl.style.display="none";
        return;
    }

    const currentStore = activeStore || stores[0];
    ctrl.style.display = "block";
    document.getElementById('delStoreBtn').onclick = () => deleteStore(currentStore);

    headers.innerHTML = stores.map(s => `<div class="tab-btn ${s===currentStore?'active':''}" onclick="renderTabs('${s}')">${s}</div>`).join('');
    
    contents.innerHTML = storeData[currentStore].slice().reverse().map((r, i) => {
        const idx = storeData[currentStore].length - 1 - i;
        return `
        <div class="record-item">
            <div style="display:flex; justify-content:space-between;">
                <b>${r.name}</b>
                <span style="color:var(--primary); font-weight:bold;">$${r.price} <small>($${r.unitPrice}/${r.unit})</small></span>
            </div>
            <div class="record-photos">${r.photos.map(p => `<img src="${p}" onclick="openLightbox('${p}')">`).join('')}</div>
            <div class="action-links">
                <span class="btn-edit" onclick="editItem('${currentStore}', ${idx})">âœï¸ ç·¨è¼¯</span>
                <span class="btn-delete" onclick="deleteItem('${currentStore}', ${idx})">ğŸ—‘ï¸ åˆªé™¤</span>
            </div>
        </div>
    `}).join('');
}

// --- ğŸ› ï¸ ç·¨è¼¯ã€åˆªé™¤ã€å–®ä½ç®¡ç† ---
function editItem(store, index) {
    const item = storeData[store][index];
    document.getElementById('storeName').value = store;
    document.getElementById('itemName').value = item.name;
    document.getElementById('price').value = item.price;
    document.getElementById('count').value = item.count;
    refreshUnitSelect(item.unit);
    currentPhotos = [null, null, null];
    if (item.photos) item.photos.forEach((p, i) => currentPhotos[i] = p);
    renderPhotoSlots();
    editingTarget = { store, index };
    document.getElementById('btnSave').innerText = "ğŸ†™ æ›´æ–°ç´€éŒ„";
    document.getElementById('btnSave').style.background = "var(--primary)";
    updateCalculation();
    liveCompare();
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function deleteItem(store, index) {
    if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
        storeData[store].splice(index, 1);
        if (storeData[store].length === 0) delete storeData[store];
        localStorage.setItem('storeTabsData', JSON.stringify(storeData));
        renderTabs();
    }
}

function deleteStore(store) {
    if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${store}ã€æ•´å€‹å•†åº—ç´€éŒ„ï¼Ÿ`)) {
        delete storeData[store];
        localStorage.setItem('storeTabsData', JSON.stringify(storeData));
        renderTabs();
    }
}

function handleUnitChange(sel) { if(sel.value==="ADD_NEW"){ const n=prompt("æ–°å–®ä½:"); if(n){ unitList.push(n); localStorage.setItem('managedUnits', JSON.stringify(unitList)); refreshUnitSelect(n); } } }

function refreshUnitSelect(target=null) {
    const sel = document.getElementById('unitSelect');
    const combined = Array.from(new Set([...DEFAULT_UNITS, ...unitList]));
    sel.innerHTML = combined.map(u => `<option value="${u}" ${u===target?'selected':''}>${u}</option>`).join('') + `<option value="ADD_NEW">â• æ–°å¢</option>`;
}

// --- ğŸ“¸ ç…§ç‰‡è™•ç† ---
function triggerFile(index) { currentSlotIndex = index; document.getElementById('file-input').click(); }
async function handleFile(input) {
    if (!input.files[0]) return;
    const base64 = await compressImage(input.files[0]);
    currentPhotos[currentSlotIndex] = base64;
    renderPhotoSlots();
    if(currentSlotIndex === 0) performOCR(input.files[0]);
    input.value = "";
}
function compressImage(file) {
    return new Promise(res => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const max = 400;
                let w = img.width, h = img.height;
                if (w > h) { if(w > max){ h *= max/w; w = max; } }
                else { if(h > max){ w *= max/h; h = max; } }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                res(canvas.toDataURL('image/jpeg', 0.6));
            };
        };
    });
}
function renderPhotoSlots() {
    currentPhotos.forEach((data, i) => {
        document.getElementById(`slot-${i}`).innerHTML = data ? `<img src="${data}"><div class="remove-p" onclick="event.stopPropagation();currentPhotos[${i}]=null;renderPhotoSlots()">Ã—</div>` : `+`;
    });
}
function openLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').style.display = 'flex'; }

async function performOCR(file) {
    const worker = await Tesseract.createWorker('chi_tra');
    const { data: { text } } = await worker.recognize(file);
    document.getElementById('itemName').value = text.split('\n')[0].trim();
    liveCompare();
    await worker.terminate();
}

function resetForm() {
    document.getElementById('itemName').value = ""; document.getElementById('price').value = "";
    document.getElementById('count').value = "1"; document.getElementById('btnSave').innerText = "âœ… å„²å­˜æ­¤ç´€éŒ„";
    document.getElementById('btnSave').style.background = "var(--success)";
    document.getElementById('compPanel').style.display = 'none';
    document.getElementById('calcResult').innerText = "-- / å–®ä½";
}

window.onload = () => {
    storeData = JSON.parse(localStorage.getItem('storeTabsData')) || {};
    unitList = JSON.parse(localStorage.getItem('managedUnits')) || [];
    refreshUnitSelect();
    renderTabs();
};
</script>
</body>
</html>
