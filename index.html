<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¯”åƒ¹åŠ©æ‰‹">
    
    <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ - V4.1.0 ğŸ“¸</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        
        /* è™•ç† iOS åº•éƒ¨å®‰å…¨å€èˆ‡ç€æµ· */
        body { 
            font-family: -apple-system, "Noto Sans TC", sans-serif; 
            background: var(--bg); margin:0; 
            padding: env(safe-area-inset-top) 15px env(safe-area-inset-bottom) 15px;
            display:flex; justify-content:center; color:#333; 
        }

        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; position: relative; }
        .designer-credit { position: absolute; top: 12px; left: 20px; font-size: 10px; color: #bbb; font-weight: bold; }

        /* ç›¸ç‰‡é¡¯ç¤ºå€åŸŸ */
        .ocr-upload-zone { background:#fffbe6; border:2px dashed #ffe58f; padding:15px; border-radius:18px; text-align:center; margin-bottom:20px; cursor:pointer; }
        #img-preview { width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; display: none; }

        /* æ­·å²ç´€éŒ„èˆ‡ç¸®åœ– */
        .record-item { background:#fff; padding:14px; border-radius:14px; margin-bottom:10px; border:1px solid #f0f0f0; display:flex; gap:12px; align-items:center; }
        .record-thumb { width: 65px; height: 65px; border-radius: 10px; object-fit: cover; background: #eee; cursor: pointer; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .record-info { flex: 1; }
        .record-price { font-weight: 800; color: var(--primary); font-size: 18px; }

        /* ğŸš€ é‡è¦ï¼šé‡å° iPhone å„ªåŒ–çš„æ”¾å¤§æ¨¡çµ„ */
        #lightbox { 
            display:none; position:fixed; inset: 0; /* ä½¿ç”¨ inset ç¢ºä¿å…¨è¢å¹• */
            background:rgba(0,0,0,0.95); z-index:10000; 
            justify-content:center; align-items:center; 
            backdrop-filter: blur(5px);
            touch-action: none; /* é˜²æ­¢æ»‘å‹•èƒŒæ™¯ */
        }
        #lightbox img { 
            max-width:100%; max-height:100%; 
            object-fit: contain;
            transition: transform 0.2s ease;
        }
        .close-lightbox {
            position: absolute; top: 40px; right: 20px; color: white;
            font-size: 30px; font-weight: bold; background: rgba(255,255,255,0.2);
            width: 44px; height: 44px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; cursor: pointer;
        }

        /* åŸæœ‰æ¨£å¼ä¿æŒ */
        .input-group { margin-bottom:12px; }
        label { display:block; margin-bottom:4px; font-size:13px; font-weight:bold; color:#666; }
        input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; box-sizing:border-box; outline:none; }
        button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; margin-bottom:10px; }
        .btn-save { background:var(--success); color:white; }
        .btn-compare { background:var(--primary); color:white; }
        .tab-headers { display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; scrollbar-width:none; }
        .tab-btn { background:#eee; padding:10px 16px; border-radius:20px; white-space:nowrap; font-size:13px; font-weight:bold; flex-shrink:0; cursor:pointer; }
        .tab-btn.active { background:var(--primary); color:white; }
    </style>
</head>
<body>

<div id="lightbox" onclick="closeZoom()">
    <div class="close-lightbox">Ã—</div>
    <img src="" id="lightbox-img" onclick="event.stopPropagation()">
</div>

<div class="container">
    <div class="designer-credit">è¨­è¨ˆè€…ï¼šLai Ade | V4.1.0 ğŸ”’</div>
    <h2 style="text-align:center; margin:10px 0 20px 0; color:var(--primary);">ğŸ›’ æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹ (iOS ä¿®å¾©ç‰ˆ)</h2>
    
    <div class="ocr-upload-zone" id="ocrTrigger">
        <div id="ocr-default-ui">
            <span style="font-size:35px;">ğŸ“¸</span>
            <p style="margin:5px 0; font-weight:bold;">æ‹æ”åƒ¹æ ¼ç‰Œ (è‡ªå‹•å£“ç¸®)</p>
        </div>
        <img id="img-preview" src="">
        <input type="file" id="ocr-upload" accept="image/*" style="display:none">
        <span id="ocr-status" class="ocr-status" style="font-size:12px; color:var(--warning)">é»æ“Šç´€éŒ„ç¸®åœ–å¯æ”¾å¤§</span>
    </div>

    <div class="input-group"><label>ğŸª å•†åº—åç¨±</label><input type="text" id="storeName" placeholder="å…¨è¯ã€å¥½å¸‚å¤š..."></div>
    <div class="input-group"><label>ğŸ“¦ å•†å“åç¨±</label><input type="text" id="itemName"></div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1.5;"><label>ğŸ’µ ç¸½åƒ¹</label><input type="number" id="price" inputmode="decimal" oninput="updateLivePrice()"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ”¢ æ•¸é‡</label><input type="number" id="count" value="1" oninput="updateLivePrice()"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ“ å–®ä½</label><select id="unitSelect" onchange="handleUnitChange(this); updateLivePrice();"></select></div>
    </div>
    <div class="input-group"><label>ğŸ“ å‚™è¨»</label><input type="text" id="remark"></div>
    
    <button class="btn-save" id="btnSave">âœ… å„²å­˜ç´€éŒ„</button>
    <button class="btn-compare" id="btnCompare">ğŸ” æ­·å²æ¯”åƒ¹</button>

    <div id="store-tabs-container">
        <div id="tab-headers" class="tab-headers"></div>
        <div id="tab-contents"></div>
    </div>
    
    <button id="btnClearAll" style="background:none; color:#999; font-size:12px; margin-top:20px; text-decoration:underline; border:none; width:auto; display:block; margin: 20px auto 0 auto;">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
</div>

<script>
/** 1. IndexedDB æ ¸å¿ƒæ¨¡çµ„ **/
const DB_NAME = 'PriceHelperDB';
const STORE_NAME = 'records';
let currentPhotoBase64 = null;
let storeData = {}; 
const DEFAULT_UNITS = ["å…¥","é¡†","å€‹","å…‹","æ¯«å‡","c.c.","åŒ…","è¢‹","ç“¶","å…¬å‡"];

function initDB() {
    return new Promise((resolve) => {
        const req = indexedDB.open(DB_NAME, 2); // å‡ç´šç‰ˆæœ¬
        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        };
        req.onsuccess = (e) => resolve(e.target.result);
    });
}

async function saveToDB(data) {
    const db = await initDB();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).add(data);
    return new Promise(r => tx.oncomplete = r);
}

async function loadFromDB() {
    const db = await initDB();
    return new Promise(r => {
        const req = db.transaction(STORE_NAME).objectStore(STORE_NAME).getAll();
        req.onsuccess = () => {
            const structured = {};
            req.result.forEach(item => {
                if(!structured[item.store]) structured[item.store] = [];
                structured[item.store].push(item);
            });
            r(structured);
        };
    });
}

/** 2. åœ–ç‰‡è™•ç†é‚è¼¯ (å„ªåŒ– iPhone é¡¯ç¤º) **/
function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const max_size = 1000; // æå‡ä¸€é»æ¸…æ™°åº¦
                let w = img.width, h = img.height;
                if (w > h) { if (w > max_size) { h *= max_size / w; w = max_size; } }
                else { if (h > max_size) { w *= max_size / h; h = max_size; } }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
        };
    });
}

/** 3. æ”¾å¤§åŠŸèƒ½ä¿®å¾© **/
function zoomImg(src) {
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightbox-img');
    lbImg.src = src;
    lb.style.display = 'flex';
    // é–å®šèƒŒæ™¯æ»‘å‹•
    document.body.style.overflow = 'hidden';
}

function closeZoom() {
    document.getElementById('lightbox').style.display = 'none';
    document.body.style.overflow = 'auto';
}

/** 4. å…¶ä»–é‚è¼¯ (OCR, UI) **/
async function handlePhoto(input) {
    if (!input.files[0]) return;
    const status = document.getElementById('ocr-status');
    status.innerText = "â³ è™•ç†ä¸­...";
    
    currentPhotoBase64 = await compressImage(input.files[0]);
    document.getElementById('ocr-default-ui').style.display = 'none';
    document.getElementById('img-preview').src = currentPhotoBase64;
    document.getElementById('img-preview').style.display = 'block';

    // OCR è¾¨è­˜ (Tesseract)
    let worker;
    try {
        worker = await Tesseract.createWorker('chi_tra+eng');
        const { data } = await worker.recognize(input.files[0]);
        const lines = (data.lines || []).map(l => l.text.trim());
        document.getElementById('itemName').value = lines[0] || "";
        status.innerText = "âœ… å®Œæˆ";
    } catch(e) { status.innerText = "è¾¨è­˜å¤±æ•—"; }
    finally { if(worker) await worker.terminate(); }
}

async function renderTabs(activeStore = null) {
    storeData = await loadFromDB();
    const headers = document.getElementById('tab-headers'), contents = document.getElementById('tab-contents');
    const storeNames = Object.keys(storeData);
    if(storeNames.length === 0) return contents.innerHTML = '<p style="text-align:center;color:#ccc;padding:20px;">ç„¡ç´€éŒ„</p>';
    if(!activeStore || !storeData[activeStore]) activeStore = storeNames[0];

    headers.innerHTML = storeNames.map(n => `<div class="tab-btn ${n === activeStore ? 'active' : ''}" onclick="renderTabs('${n}')">${n}</div>`).join('');
    
    contents.innerHTML = (storeData[activeStore] || []).slice().reverse().map(r => `
        <div class="record-item">
            <img src="${r.photo || ''}" class="record-thumb" onclick="zoomImg('${r.photo}')" onerror="this.style.display='none'">
            <div class="record-info">
                <b>${r.name}</b><br>
                <small>${r.date} Â· ${r.count}${r.unit}</small>
                <div style="font-size:12px;color:var(--danger)">å–®åƒ¹: $${(r.price/r.count).toFixed(2)}</div>
            </div>
            <div class="record-price">$${r.price}</div>
        </div>`).join('');
}

window.onload = async () => {
    document.getElementById('ocrTrigger').onclick = () => document.getElementById('ocr-upload').click();
    document.getElementById('ocr-upload').onchange = e => handlePhoto(e.target);
    document.getElementById('btnSave').onclick = async () => {
        const data = {
            store: document.getElementById('storeName').value || "æœªå‘½åå•†åº—",
            name: document.getElementById('itemName').value,
            price: parseFloat(document.getElementById('price').value),
            count: parseFloat(document.getElementById('count').value) || 1,
            unit: document.getElementById('unitSelect').value,
            photo: currentPhotoBase64,
            date: new Date().toLocaleDateString()
        };
        await saveToDB(data);
        location.reload();
    };
    
    const sel = document.getElementById('unitSelect');
    sel.innerHTML = DEFAULT_UNITS.map(u => `<option value="${u}">${u}</option>`).join('');
    renderTabs();
};

function updateLivePrice() {
    const p = parseFloat(document.getElementById('price').value) || 0;
    const c = parseFloat(document.getElementById('count').value) || 1;
    if(p>0) document.getElementById('ocr-status').innerText = `å³æ™‚å–®åƒ¹ï¼š$${(p/c).toFixed(2)}`;
}
</script>
</body>
</html>
