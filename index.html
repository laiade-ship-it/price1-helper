async function performOCR(input) {
    if (!input.files || !input.files[0]) return;
    const status = document.getElementById('ocr-status');
    status.innerText = "⌛ 辨識中...";

    try {
        const r = await Tesseract.recognize(input.files[0], 'chi_tra+eng');
        const lines = r.data.text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

        let priceCandidates = [];
        let nameBuffer = [];
        let stopNameMerging = false;

        // --- 屬性排除正則 (數字+單位)
        const attributeRegex = /\d+\s?(ml|毫升|g|公克|克|kg|公斤|入|包|瓶|罐|oz|盎司|入組|x|X|pc|pack)/gi;
        const modelNoiseRegex = /\b[a-z]+\d+|\d+[a-z]+\b/gi;

        // 價格語意正則
        const semanticPriceRegex = /(?:[$¥]|NT\$|特價|售價|原價|金額|總計|Total)[:：\s]*([\d,]{1,7}(?:\.\d{1,2})?)/gi;

        const blacklist = ['公司', '地址', '保存', '日期', '有效', '編號', 'No', '產地', '網址', '總計', 'Total'];

        lines.forEach(line => {
            // --- A. 先剔除屬性單位與型號干擾 ---
            let cleanLine = line.replace(attributeRegex, '[ATTR]').replace(modelNoiseRegex, '');

            // --- B. 價格抓取 ---
            const hasPriceKeyword = /[$¥]|NT\$|特價|售價|原價|金額|總計|Total/i.test(line);
            if (hasPriceKeyword) {
                let match;
                while ((match = semanticPriceRegex.exec(cleanLine)) !== null) {
                    const val = parseFloat(match[1].replace(/,/g, ''));
                    let score = 100;
                    if (/特價|Total|[$¥]/i.test(match[0])) score += 200;
                    if (/原價/i.test(match[0])) score -= 50;
                    priceCandidates.push({ val, score });
                }
            }

            // fallback：孤立數字，但跳過被替換的屬性 [ATTR]
            if (priceCandidates.length === 0) {
                const isolatedNumbers = cleanLine.match(/(?:^|\s)(\d{1,5})(?:\s|$)/g);
                if (isolatedNumbers) {
                    isolatedNumbers.forEach(numStr => {
                        if (numStr.includes('[ATTR]')) return; // 排除屬性
                        priceCandidates.push({ val: parseFloat(numStr.trim()), score: 50 });
                    });
                }
            }

            // --- C. 品名合併邏輯 ---
            if (!stopNameMerging) {
                const isBlacklisted = blacklist.some(word => line.includes(word));
                const textOnly = cleanLine.replace(/[\d\s,.$¥NT:：*＊\-\/]/g, '');
                const ratio = line.length > 0 ? textOnly.length / line.length : 0;

                // 停止條件：遇到價格行或黑名單或長數字行
                if (hasPriceKeyword || isBlacklisted || /\d{10,}/.test(line)) {
                    stopNameMerging = true;
                } else if (ratio > 0.4 && line.length > 1) {
                    nameBuffer.push(textOnly.trim());
                }
            }
        });

        // --- D. 輸出結果 ---
        const bestPrice = priceCandidates.sort((a, b) => b.score - a.score)[0];
        document.getElementById('price').value = bestPrice ? bestPrice.val : '';
        document.getElementById('itemName').value = nameBuffer.join(' ');
        status.innerText = "✅ 辨識完成";
        calculate();
        updateHistory();

    } catch (e) {
        status.innerText = "❌ 辨識失敗";
        console.error(e);
    }
}
