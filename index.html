<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ - åš´æ ¼ LCS ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; color: #333; }
        .container { width: 100%; max-width: 480px; background: var(--card); padding: 20px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); box-sizing: border-box; }
        
        /* åŸºç¤ UI */
        .ocr-upload-zone { background: #fffbe6; border: 2px dashed #ffe58f; padding: 20px; border-radius: 18px; text-align: center; margin-bottom: 20px; cursor: pointer; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-size: 13px; font-weight: bold; color: #666; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; transition: 0.2s; margin-top: 5px; cursor: pointer; }
        .btn-save { background: var(--success); color: white; }
        .btn-compare { background: var(--primary); color: white; margin-top: 10px; }
        
        /* æ¯”åƒ¹çµæœå€å¡Š - æµ®å‹•æ„Ÿè¨­è¨ˆ */
        #comparison-area { margin: 15px 0; display: none; }
        .compare-box { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 16px; padding: 15px; position: relative; }
        .compare-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #dbeafe; padding-bottom: 5px; }
        .compare-item { background: white; border-radius: 10px; padding: 10px; margin-bottom: 8px; border-left: 4px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .compare-item.best-match { border-left-color: var(--warning); background: #fffbeb; }
        .badge-best { background: var(--warning); color: #856404; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-bottom: 4px; display: inline-block; }
        
        .item-meta { font-size: 11px; color: #64748b; margin-top: 2px; }
        .price-row { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 6px; }
        .unit-price { color: var(--danger); font-weight: bold; font-size: 14px; }

        /* åˆ†é ç³»çµ±ä¿æŒä¸è®Š */
        #store-tabs-container { margin-top: 20px; border-top: 2px solid #f1f5f9; padding-top: 15px; }
        .tab-headers { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .tab-btn { background: #e2e8f0; padding: 8px 14px; border-radius: 15px; white-space: nowrap; font-size: 12px; font-weight: bold; flex-shrink: 0; }
        .tab-btn.active { background: var(--primary); color: white; }
        .record-item { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .record-price { font-weight: 800; color: var(--primary); font-size: 16px; }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align:center; margin:0 0 15px 0; color:var(--primary);">ğŸ›’ ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹</h2>
    
    <div class="ocr-upload-zone" id="ocrTrigger">
        <span style="font-size:30px;">ğŸ“¸</span>
        <p style="margin:5px 0; font-weight:bold; font-size:14px;">æ‹ç…§è¾¨è­˜åƒ¹æ ¼ç‰Œ</p>
        <input type="file" id="ocr-upload" accept="image/*" style="display:none">
        <span id="ocr-status" style="font-size:12px; color:#856404;">é»æ“Šé–‹å§‹è¾¨è­˜</span>
    </div>
    
    <div class="input-group"><label>ğŸª å•†åº—åç¨±</label><input type="text" id="storeName" placeholder="å…¨è¯ã€å¥½å¸‚å¤š..."></div>
    <div class="input-group"><label>ğŸ“¦ å•†å“åç¨±</label><input type="text" id="itemName" placeholder="è«‹è¼¸å…¥æˆ–è¾¨è­˜å•†å“"></div>
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:2;"><label>ğŸ’µ åƒ¹æ ¼ (å…ƒ)</label><input type="number" id="price" inputmode="decimal"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ”¢ æ•¸é‡</label><input type="number" id="count" value="1" inputmode="numeric"></div>
    </div>

    <button class="btn-save" id="btnSave">âœ… å„²å­˜æ­¤ç´€éŒ„</button>
    <button class="btn-compare" id="btnCompare">ğŸ” åŸ·è¡Œæ­·å²æ¯”åƒ¹</button>

    <div id="comparison-area">
        <div class="compare-box">
            <div class="compare-header">
                <span style="font-weight:bold; color:#1e40af; font-size:14px;">ğŸ“Š æ­·å²æ¯”åƒ¹ (LCS â‰¥ 2)</span>
                <span id="closeCompare" style="cursor:pointer; padding:0 5px;">âœ•</span>
            </div>
            <div id="compareList"></div>
        </div>
    </div>

    <div id="store-tabs-container">
        <div id="tab-headers" class="tab-headers"></div>
        <div id="tab-contents"></div>
    </div>
</div>

<script>
let storeData = {};

function init() {
    try {
        storeData = JSON.parse(localStorage.getItem('storeTabsData')) || {};
        if (Array.isArray(storeData)) storeData = {};
    } catch(e) { storeData = {}; }
    setupEventListeners();
    renderTabs();
}

// æ ¸å¿ƒæ¼”ç®—æ³•ï¼šæœ€é•·é€£çºŒå­—ä¸² (LCS) é•·åº¦
function getLCSLength(s1, s2) {
    if (!s1 || !s2) return 0;
    const str1 = String(s1).toLowerCase();
    const str2 = String(s2).toLowerCase();
    const m = str1.length, n = str2.length;
    const dp = Array(m + 1).fill(0).map(() => Array(n + 1).fill(0));
    let maxLen = 0;
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (str1[i - 1] === str2[j - 1]) {
                dp[i][j] = dp[i - 1][j - 1] + 1;
                maxLen = Math.max(maxLen, dp[i][j]);
            }
        }
    }
    return maxLen;
}

function comparePrices() {
    const query = document.getElementById('itemName').value.trim();
    if (query.length < 1) return alert("è«‹è¼¸å…¥å•†å“åç¨±å†é€²è¡Œæ¯”åƒ¹");

    let validMatches = [];
    
    // éæ­·æ‰€æœ‰æ­·å²è³‡æ–™é€²è¡Œã€Œåš´æ ¼éæ¿¾ã€
    Object.keys(storeData).forEach(store => {
        storeData[store].forEach(item => {
            const lcsLen = getLCSLength(query, item.name);
            
            // åš´æ ¼è¦å‰‡ï¼šåƒ… LCS é•·åº¦ >= 2 æ‰åŠ å…¥åˆ—è¡¨
            if (lcsLen >= 2) {
                validMatches.push({
                    ...item,
                    store: store,
                    lcs: lcsLen,
                    unitPrice: item.price / item.count
                });
            }
        });
    });

    const area = document.getElementById('comparison-area');
    const list = document.getElementById('compareList');

    if (validMatches.length === 0) {
        list.innerHTML = `<div style="text-align:center; color:#64748b; font-size:13px; padding:10px;">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶ (LCS â‰¥ 2) çš„ç´€éŒ„</div>`;
        area.style.display = 'block';
        return;
    }

    // æ’åºè¦å‰‡ï¼š1. LCS é•·åº¦ (é™åº) 2. å–®åƒ¹ (å‡åº)
    validMatches.sort((a, b) => b.lcs - a.lcs || a.unitPrice - b.unitPrice);

    // æ‰¾å‡º CP å€¼æœ€é«˜è€… (éæ¿¾å¾Œçš„å–®åƒ¹æœ€ä½å€¼)
    const minPrice = Math.min(...validMatches.map(m => m.unitPrice));

    list.innerHTML = validMatches.map(m => {
        const isBest = m.unitPrice === minPrice;
        return `
            <div class="compare-item ${isBest ? 'best-match' : ''}">
                ${isBest ? '<span class="badge-best">ğŸ† æœ€æ¨è–¦ (CPå€¼æœ€é«˜)</span>' : ''}
                <div style="font-weight:bold; font-size:14px;">${escapeHtml(m.name)}</div>
                <div class="item-meta">ğŸª ${escapeHtml(m.store)} | ğŸ“… ${m.date}</div>
                <div class="price-row">
                    <small style="color:#666;">$${m.price} / ${m.count}å…¥ (åŒ¹é…:${m.lcs}å­—)</small>
                    <span class="unit-price">å–®åƒ¹: $${m.unitPrice.toFixed(2)}</span>
                </div>
            </div>
        `;
    }).join('');

    area.style.display = 'block';
    area.scrollIntoView({ behavior: 'smooth' });
}

/* ------------------ ä»¥ä¸‹ç¶­æŒåŸå§‹ç©©å®šé‚è¼¯ ------------------ */

function setupEventListeners() {
    document.getElementById('ocrTrigger').addEventListener('click', () => document.getElementById('ocr-upload').click());
    document.getElementById('ocr-upload').addEventListener('change', e => performOCR(e.target));
    document.getElementById('btnSave').addEventListener('click', saveRecord);
    document.getElementById('btnCompare').addEventListener('click', comparePrices);
    document.getElementById('closeCompare').addEventListener('click', () => document.getElementById('comparison-area').style.display='none');
    
    document.getElementById('tab-headers').addEventListener('click', e => {
        const btn = e.target.closest('.tab-btn');
        if(btn) renderTabs(btn.dataset.store);
    });

    document.getElementById('tab-contents').addEventListener('click', e => {
        const action = e.target.closest('[data-item-action]');
        if(action && action.dataset.itemAction === 'delete') {
            deleteItem(action.dataset.store, parseInt(action.dataset.index));
        }
    });
}

async function performOCR(input) {
    if(!input.files[0]) return;
    const status = document.getElementById('ocr-status');
    status.innerText = "â³ è¾¨è­˜ä¸­...";
    try {
        const worker = await Tesseract.createWorker('chi_tra+eng');
        const { data } = await worker.recognize(input.files[0]);
        // ç°¡å–®æå–ç¬¬ä¸€è¡Œä½œç‚ºå“å
        const firstLine = data.lines[0]?.text.trim().replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g,'') || "";
        document.getElementById('itemName').value = firstLine;
        status.innerText = "âœ… è¾¨è­˜å®Œæˆ";
        await worker.terminate();
    } catch(e) { status.innerText = "âŒ å¤±æ•—"; }
}

function saveRecord() {
    const store = document.getElementById('storeName').value.trim() || "æœªåˆ†é¡";
    const name = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const count = parseInt(document.getElementById('count').value) || 1;
    if(!name || isNaN(price)) return alert("è«‹å¡«å¯«å“åèˆ‡åƒ¹æ ¼");
    
    if(!storeData[store]) storeData[store] = [];
    storeData[store].push({ name, price, count, date: new Date().toLocaleDateString() });
    localStorage.setItem('storeTabsData', JSON.stringify(storeData));
    renderTabs(store);
    document.getElementById('itemName').value = '';
    document.getElementById('price').value = '';
    alert("å„²å­˜æˆåŠŸï¼");
}

function renderTabs(activeStore = null) {
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    const names = Object.keys(storeData);
    if(names.length === 0) { contents.innerHTML = '<p style="text-align:center;color:#ccc;">å°šç„¡è³‡æ–™</p>'; return; }
    if(!activeStore || !storeData[activeStore]) activeStore = names[names.length-1];

    headers.innerHTML = names.map(n => `<div class="tab-btn ${n===activeStore?'active':''}" data-store="${n}">${escapeHtml(n)}</div>`).join('');
    const records = storeData[activeStore] || [];
    contents.innerHTML = records.slice().reverse().map((r, i) => `
        <div class="record-item">
            <div><b>${escapeHtml(r.name)}</b><br><small>${r.date} Â· ${r.count}å€‹</small></div>
            <div style="display:flex; align-items:center;">
                <span class="record-price">$${r.price}</span>
                <span style="color:red; margin-left:10px; font-size:12px; cursor:pointer;" data-item-action="delete" data-store="${activeStore}" data-index="${records.length-1-i}">åˆªé™¤</span>
            </div>
        </div>
    `).join('');
}

function deleteItem(s, i) {
    if(confirm("åˆªé™¤ï¼Ÿ")) {
        storeData[s].splice(i, 1);
        if(storeData[s].length === 0) delete storeData[s];
        localStorage.setItem('storeTabsData', JSON.stringify(storeData));
        renderTabs();
    }
}

function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

window.onload = init;
</script>
</body>
</html>
