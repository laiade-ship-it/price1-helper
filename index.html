<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ - ç©©å®šå®‰å…¨ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
:root { --primary:#4a90e2; --bg:#f8f9fa; --card:#fff; --success:#27ae60; }
body { font-family:-apple-system,"Noto Sans TC",sans-serif; background:var(--bg); margin:0; padding:15px; display:flex; justify-content:center; }
.container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:20px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
.ocr-upload-zone { background:#fffbe6; border:2px dashed #ffe58f; padding:20px; border-radius:15px; text-align:center; cursor:pointer; }
.input-group { margin-top:15px; }
label { font-size:14px; font-weight:bold; color:#666; }
input { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; }
button { width:100%; padding:14px; border:none; border-radius:12px; font-weight:bold; cursor:pointer; margin-top:12px; }
.btn-save { background:var(--success); color:#fff; }
.tab-btn { padding:6px 14px; border-radius:20px; background:#eee; cursor:pointer; font-size:13px; }
.tab-btn.active { background:var(--primary); color:#fff; }
.record-item { background:#fff; padding:10px; border-radius:10px; margin-bottom:8px; border:1px solid #eee; display:flex; justify-content:space-between; }
</style>
</head>

<body>
<div class="container">
<h2 style="text-align:center;color:#4a90e2;">ğŸ›’ æ¯”åƒ¹å°å¹«æ‰‹</h2>

<div class="ocr-upload-zone" onclick="document.getElementById('ocr-upload').click()">
ğŸ“¸ é»æ“Šæ‹æ”åƒ¹æ ¼ç‰Œ
<input type="file" id="ocr-upload" accept="image/*" style="display:none" onchange="performOCR(this)">
<p id="ocr-status">ç­‰å¾…è¾¨è­˜</p>
</div>

<div class="input-group">
<label>ğŸª å•†åº—</label>
<input id="storeName" placeholder="ä¾‹å¦‚ï¼šå…¨è¯">
</div>

<div class="input-group">
<label>ğŸ“¦ å•†å“åç¨±</label>
<input id="itemName">
</div>

<div class="input-group">
<label>ğŸ’µ åƒ¹æ ¼</label>
<input id="price" type="number">
</div>

<button class="btn-save" onclick="saveRecord()">å„²å­˜</button>

<div style="margin-top:20px;">
<div id="tab-headers" style="display:flex;gap:8px;overflow-x:auto;"></div>
<div id="tab-contents"></div>
</div>
</div>

<script>
/* ------------------ å®‰å…¨åˆå§‹åŒ– ------------------ */
let storeData = {};

try {
    const raw = localStorage.getItem('storeTabsData');
    if (raw) storeData = JSON.parse(raw);
    if (Array.isArray(storeData)) storeData = {};
} catch (e) {
    storeData = {};
}

/* ------------------ OCR æ ¸å¿ƒï¼ˆ100% é˜²å‘†ï¼‰ ------------------ */
async function performOCR(input) {
    const status = document.getElementById('ocr-status');
    if (!input || !input.files || !input.files[0]) return;

    status.innerText = "â³ è¾¨è­˜ä¸­...";
    let worker;

    try {
        worker = await Tesseract.createWorker();
        await worker.loadLanguage('chi_tra+eng');
        await worker.initialize('chi_tra+eng');

        const { data } = await worker.recognize(input.files[0]);
        const lines = (data.lines || []).map(l => l.text.trim()).filter(Boolean);

        let nameParts = [];
        let prices = [];

        const priceSemantic = /(?:NT\$|\$|ç‰¹åƒ¹|å”®åƒ¹|ç¸½è¨ˆ)[:ï¼š\s]*([\d,]{2,7})/i;
        const barcode = /^\d{8,13}$/;

        lines.forEach(line => {
            if (/[\u4e00-\u9fa5a-zA-Z]/.test(line) && nameParts.length < 2 && !priceSemantic.test(line)) {
                nameParts.push(line.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g,'').trim());
            }

            const m = line.match(priceSemantic);
            if (m) prices.push(parseInt(m[1].replace(/,/g,'')));

            if (!m && !barcode.test(line)) {
                const f = line.match(/\b\d{2,5}\b/g);
                if (f) f.forEach(n => prices.push(parseInt(n)));
            }
        });

        document.getElementById('itemName').value = nameParts.join(' ');
        document.getElementById('price').value = prices.length ? Math.max(...prices) : "";

        status.innerText = prices.length ? "âœ… è¾¨è­˜å®Œæˆ" : "âš ï¸ æœªæŠ“åˆ°åƒ¹æ ¼";

    } catch (err) {
        console.error(err);
        status.innerText = "âŒ OCR å¤±æ•—ï¼Œå¯æ‰‹å‹•è¼¸å…¥";
    } finally {
        if (worker) {
            try { await worker.terminate(); } catch {}
        }
    }
}

/* ------------------ å„²å­˜èˆ‡åˆ†é  ------------------ */
function saveRecord() {
    const store = document.getElementById('storeName').value || "æœªåˆ†é¡";
    const name = document.getElementById('itemName').value;
    const price = document.getElementById('price').value;

    if (!name || !price) return alert("è«‹å¡«å“åèˆ‡åƒ¹æ ¼");

    if (!storeData[store]) storeData[store] = [];
    storeData[store].push({ name, price, date: new Date().toLocaleDateString() });

    localStorage.setItem('storeTabsData', JSON.stringify(storeData));
    renderTabs(store);
}

function renderTabs(active) {
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    if (!headers || !contents) return;

    const stores = Object.keys(storeData);
    if (!stores.length) return;

    active = active || stores[stores.length - 1];

    headers.innerHTML = stores.map(s =>
        `<div class="tab-btn ${s===active?'active':''}" onclick="renderTabs('${s}')">${s}</div>`
    ).join('');

    contents.innerHTML = storeData[active].slice().reverse().map(r =>
        `<div class="record-item"><div>${r.name}<br><small>${r.date}</small></div><div>$${r.price}</div></div>`
    ).join('');
}

renderTabs();
</script>
</body>
</html>
