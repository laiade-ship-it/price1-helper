<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ - V4.0.0 ğŸ“¸</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; color:#333; }
        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; position: relative; }
        
        .designer-credit { position: absolute; top: 12px; left: 20px; font-size: 10px; color: #bbb; font-weight: bold; letter-spacing: 0.5px; }
        
        /* ç…§ç‰‡é è¦½å€åŸŸ */
        .ocr-upload-zone { background:#fffbe6; border:2px dashed #ffe58f; padding:15px; border-radius:18px; text-align:center; margin-bottom:20px; cursor:pointer; margin-top: 15px; overflow: hidden; position: relative; min-height: 80px; }
        #preview-container { display: none; margin-top: 10px; }
        #img-preview { width: 100%; max-height: 200px; object-fit: contain; border-radius: 10px; }

        .input-group { margin-bottom:15px; }
        label { display:block; margin-bottom:6px; font-size:14px; font-weight:bold; color:#666; }
        input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; box-sizing:border-box; outline:none; background: white; }
        button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; margin-bottom:10px; transition: 0.2s; }
        .btn-save { background:var(--success); color:white; }
        .btn-compare { background:var(--primary); color:white; }
        
        /* æ­·å²ç´€éŒ„èˆ‡ç¸®åœ– */
        .record-item { background:#fff; padding:14px; border-radius:14px; margin-bottom:10px; border:1px solid #f0f0f0; display:flex; gap:12px; align-items:center; }
        .record-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; background: #eee; cursor: zoom-in; flex-shrink: 0; }
        .record-info { flex: 1; }
        .record-price { text-align:right; font-weight:800; color:var(--primary); font-size:18px; min-width: 70px; }
        
        /* æ”¾å¤§æ¨¡çµ„ (Lightbox) */
        #lightbox { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center; cursor: zoom-out; }
        #lightbox img { max-width:95%; max-height:95%; border-radius:8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* åŸæœ‰æ¨™ç±¤æ¨£å¼ */
        .tab-headers { display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; scrollbar-width:none; }
        .tab-btn { background:#eee; padding:10px 16px; border-radius:20px; white-space:nowrap; font-size:13px; font-weight:bold; flex-shrink:0; cursor:pointer; }
        .tab-btn.active { background:var(--primary); color:white; }
        .compare-item { background:white; border-radius:10px; padding:10px; margin-bottom:8px; border-left:4px solid #ddd; position:relative; }
        #comparison-area { margin-top:15px; display:none; position: fixed; top: 5%; left: 5%; width: 90%; height: 80%; background: white; z-index: 1000; padding: 20px; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.3); overflow-y: auto; }
        .ctrl-mini-btn { font-size:11px; padding:5px 10px; border-radius:8px; background:#f0f0f0; border:1px solid #ddd; cursor:pointer; }
        .tab-controls { display:flex; gap:8px; margin-bottom:10px; justify-content: flex-end; }
    </style>
</head>
<body>

<div id="lightbox" onclick="this.style.display='none'"><img src="" id="lightbox-img"></div>

<div class="container">
    <div class="designer-credit">è¨­è¨ˆè€…ï¼šLai Ade | V4.0.0</div>
    <h2 style="text-align:center; margin:10px 0 20px 0; color:var(--primary);">ğŸ›’ æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹ (ç›¸ç‰‡ç‰ˆ)</h2>
    
    <div class="ocr-upload-zone" id="ocrTrigger">
        <div id="ocr-default-ui">
            <span style="font-size:35px;">ğŸ“¸</span>
            <p style="margin:5px 0; font-weight:bold;">æ‹æ”åƒ¹æ ¼ç‰Œ (è‡ªå‹•å£“ç¸®)</p>
        </div>
        <div id="preview-container">
            <img id="img-preview" src="">
        </div>
        <input type="file" id="ocr-upload" accept="image/*" style="display:none">
        <span id="ocr-status" class="ocr-status" style="font-size:12px; color:var(--warning)">æ”¯æ´ç…§ç‰‡å­˜å„²èˆ‡æ”¾å¤§</span>
    </div>

    <div class="input-group"><label>ğŸª å•†åº—åç¨±</label><input type="text" id="storeName" placeholder="ä¾‹å¦‚ï¼šå…¨è¯ã€å¥½å¸‚å¤š"></div>
    <div class="input-group"><label>ğŸ“¦ å•†å“åç¨±</label><input type="text" id="itemName" placeholder="è¾¨è­˜çµæœå°‡å‡ºç¾åœ¨æ­¤"></div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1.5;"><label>ğŸ’µ ç¸½åƒ¹</label><input type="number" id="price" inputmode="decimal" oninput="updateLivePrice()"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ”¢ æ•¸é‡</label><input type="number" id="count" value="1" oninput="updateLivePrice()"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ“ å–®ä½</label><select id="unitSelect" onchange="handleUnitChange(this); updateLivePrice();"></select></div>
    </div>
    <div class="input-group"><label>ğŸ“ å‚™è¨»æ¬„</label><input type="text" id="remark" placeholder="è²·ä¸€é€ä¸€ç­‰"></div>
    
    <button class="btn-save" id="btnSave">âœ… å„²å­˜æ­¤ç´€éŒ„ (å«ç…§ç‰‡)</button>
    <button class="btn-compare" id="btnCompare">ğŸ” æ­·å²æ¯”åƒ¹ (CPå€¼)</button>

    <div id="comparison-area">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>ğŸ“Š æ¯”åƒ¹çµæœ</h3>
            <span onclick="document.getElementById('comparison-area').style.display='none'" style="cursor:pointer; font-size:24px;">Ã—</span>
        </div>
        <div id="compareList"></div>
    </div>

    <div id="store-tabs-container">
        <div id="tab-controls" class="tab-controls"></div>
        <div id="tab-headers" class="tab-headers"></div>
        <div id="tab-contents"></div>
    </div>
    
    <button id="btnClearAll" style="background:none; color:#999; font-size:12px; margin-top:20px; text-decoration:underline; border:none; width:auto; display:block; margin: 20px auto 0 auto;">æ¸…ç©ºæ‰€æœ‰è³‡æ–™åº«</button>
</div>

<script>
/** 1. IndexedDB æ ¸å¿ƒæ§åˆ¶ (æ”¯æ´ç…§ç‰‡ Blob) **/
const DB_NAME = 'PriceHelperDB';
const STORE_NAME = 'records';
let currentPhotoBase64 = null;
let storeData = {}; 
let currentActiveStore = null;
let unitList = [];
const DEFAULT_UNITS = ["å…¥","é¡†","å€‹","å…‹","æ¯«å‡","c.c.","åŒ…","è¢‹","ç“¶","å…¬å‡"];

function initDB() {
    return new Promise((resolve) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        };
        request.onsuccess = (e) => resolve(e.target.result);
    });
}

async function saveToDB(data) {
    const db = await initDB();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).add(data);
    return new Promise(r => tx.oncomplete = r);
}

async function loadFromDB() {
    const db = await initDB();
    return new Promise(r => {
        const req = db.transaction(STORE_NAME).objectStore(STORE_NAME).getAll();
        req.onsuccess = () => {
            // å°‡æ‰å¹³çš„ DB è³‡æ–™è½‰æ›å›åŸæœ¬çš„ storeData çµæ§‹
            const raw = req.result;
            const structured = {};
            raw.forEach(item => {
                if(!structured[item.store]) structured[item.store] = [];
                structured[item.store].push(item);
            });
            r(structured);
        };
    });
}

/** 2. ç…§ç‰‡å£“ç¸®é‚è¼¯ **/
function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const max_size = 800; // æœ€å¤§å¯¬åº¦/é«˜åº¦

                if (width > height) {
                    if (width > max_size) { height *= max_size / width; width = max_size; }
                } else {
                    if (height > max_size) { width *= max_size / height; height = max_size; }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                // å£“ç¸®è³ªé‡ 0.6
                resolve(canvas.toDataURL('image/jpeg', 0.6));
            };
        };
    });
}

/** 3. OCR èˆ‡ç…§ç‰‡è™•ç† **/
async function handlePhoto(input) {
    if (!input.files[0]) return;
    const status = document.getElementById('ocr-status');
    status.innerText = "â³ æ­£åœ¨è™•ç†ç…§ç‰‡èˆ‡è¾¨è­˜...";
    
    // å£“ç¸®ä¸¦é¡¯ç¤ºé è¦½
    currentPhotoBase64 = await compressImage(input.files[0]);
    document.getElementById('ocr-default-ui').style.display = 'none';
    document.getElementById('preview-container').style.display = 'block';
    document.getElementById('img-preview').src = currentPhotoBase64;

    // OCR è¾¨è­˜ (ç¹¼æ‰¿ V3.6.1)
    let worker;
    try {
        worker = await Tesseract.createWorker('chi_tra+eng');
        const { data } = await worker.recognize(input.files[0]);
        const lines = (data.lines || []).map(l => l.text.trim()).filter(Boolean);
        let nameLines = [], priceCandidates = [];
        const priceSemantic = /(?:NT\$|\$|ç‰¹åƒ¹|å”®åƒ¹|é‡‘é¡|ç¸½è¨ˆ|åƒ¹æ ¼)[:ï¼š\s]*([\d,]{2,7})/i;
        
        lines.forEach(line => {
            const cleanLine = line.trim();
            const sMatch = cleanLine.match(priceSemantic);
            if (sMatch) priceCandidates.push({ val: parseInt(sMatch[1].replace(/,/g, '')), score: 100 });
            const pMatches = cleanLine.match(/\b\d{2,5}\b/g);
            if (pMatches) pMatches.forEach(m => { const v = parseInt(m); if (v > 15) priceCandidates.push({ val: v, score: 50 }); });
            if (/[\u4e00-\u9fa5]/.test(cleanLine) && nameLines.length < 2) nameLines.push(cleanLine);
        });
        
        priceCandidates.sort((a,b)=>b.score - a.score);
        document.getElementById('itemName').value = nameLines.join(' ');
        if (priceCandidates.length > 0) document.getElementById('price').value = priceCandidates[0].val;
        updateLivePrice();
        status.innerText = "âœ… è¾¨è­˜æˆåŠŸï¼Œç…§ç‰‡å·²å‚™ä»½";
    } catch(e) { 
        status.innerText = "âŒ è¾¨è­˜ç•¥éï¼Œåƒ…å„²å­˜ç›¸ç‰‡"; 
    } finally { 
        if(worker) await worker.terminate(); 
    }
}

/** 4. UI é‚è¼¯ **/
function updateLivePrice() {
    const p = parseFloat(document.getElementById('price').value) || 0;
    const c = parseFloat(document.getElementById('count').value) || 1;
    const u = document.getElementById('unitSelect').value;
    const status = document.getElementById('ocr-status');
    if (p > 0) status.innerText = `ğŸ’¡ å³æ™‚å–®åƒ¹ï¼š$${(p/c).toFixed(2)} / ${u}`;
}

async function saveRecord() {
    const store = document.getElementById('storeName').value.trim() || "æœªåˆ†é¡å•†åº—";
    const name = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const count = parseInt(document.getElementById('count').value) || 1;
    const unit = document.getElementById('unitSelect').value;
    const remark = document.getElementById('remark').value.trim();

    if(!name || isNaN(price)) return alert("è«‹è¼¸å…¥å“åèˆ‡åƒ¹æ ¼");

    const record = {
        store, name, price, count, unit, remark,
        photo: currentPhotoBase64,
        date: new Date().toLocaleDateString()
    };

    await saveToDB(record);
    storeData = await loadFromDB(); // é‡æ–°è®€å–
    resetInputs();
    renderTabs(store);
}

function renderTabs(activeStore = null) {
    const headers = document.getElementById('tab-headers'), contents = document.getElementById('tab-contents');
    const storeNames = Object.keys(storeData);
    
    if(storeNames.length === 0) {
        contents.innerHTML = '<p style="text-align:center;color:#ccc;padding:20px;">è³‡æ–™åº«ç‚ºç©º</p>';
        return;
    }

    if(!activeStore || !storeData[activeStore]) activeStore = storeNames[0];
    currentActiveStore = activeStore;

    headers.innerHTML = storeNames.map(n => `<div class="tab-btn ${n === activeStore ? 'active' : ''}" onclick="renderTabs('${n}')">${n}</div>`).join('');
    
    const records = storeData[activeStore] || [];
    contents.innerHTML = records.slice().reverse().map(r => {
        const unitP = (r.price / (r.count || 1)).toFixed(2);
        return `
        <div class="record-item">
            ${r.photo ? `<img src="${r.photo}" class="record-thumb" onclick="zoomImg('${r.photo}')">` : `<div class="record-thumb" style="display:flex;align-items:center;justify-content:center;font-size:10px;color:#ccc">ç„¡ç›¸ç‰‡</div>`}
            <div class="record-info">
                <b>${r.name}</b><br>
                <small>${r.date} Â· ${r.count}${r.unit} (å–®åƒ¹: ${unitP})</small>
                <div style="font-size:11px;color:var(--danger)">$${unitP} / ${r.unit}</div>
            </div>
            <div class="record-price">$${r.price}</div>
        </div>`;
    }).join('');
}

function zoomImg(src) {
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightbox-img');
    lbImg.src = src;
    lb.style.display = 'flex';
}

function resetInputs() {
    document.getElementById('itemName').value = '';
    document.getElementById('price').value = '';
    document.getElementById('remark').value = '';
    document.getElementById('preview-container').style.display = 'none';
    document.getElementById('ocr-default-ui').style.display = 'block';
    currentPhotoBase64 = null;
    document.getElementById('ocr-status').innerText = "æ”¯æ´ç…§ç‰‡å­˜å„²èˆ‡æ”¾å¤§";
}

/** 5. å•Ÿå‹• **/
window.onload = async () => {
    storeData = await loadFromDB();
    document.getElementById('ocrTrigger').onclick = () => document.getElementById('ocr-upload').click();
    document.getElementById('ocr-upload').onchange = e => handlePhoto(e.target);
    document.getElementById('btnSave').onclick = saveRecord;
    
    // åˆå§‹åŒ–å–®ä½
    const sel = document.getElementById('unitSelect');
    sel.innerHTML = DEFAULT_UNITS.map(u => `<option value="${u}">${u}</option>`).join('') + `<option value="ADD_NEW">â• æ–°å¢</option>`;
    
    renderTabs();
};

function handleUnitChange(sel) {
    if (sel.value === "ADD_NEW") {
        const n = prompt("è¼¸å…¥æ–°å–®ä½:");
        if (n) {
            const opt = document.createElement("option");
            opt.value = n; opt.text = n; sel.add(opt, sel[0]);
            sel.value = n;
        }
    }
}
</script>
</body>
</html>
