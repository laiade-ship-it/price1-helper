<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ V4.5 ğŸ§±</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; color:#333; }
        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; position: relative; }
        .designer-credit { position: absolute; top: 12px; left: 20px; font-size: 10px; color: #bbb; font-weight: bold; }
        
        .ocr-upload-zone { background:#fffbe6; border:2px dashed #ffe58f; padding:25px; border-radius:18px; text-align:center; margin-bottom:20px; cursor:pointer; margin-top: 15px; }
        .ocr-status { font-size:13px; color:#856404; font-weight:bold; margin-top:10px; display:block; }
        
        .input-group { margin-bottom:12px; }
        label { display:block; margin-bottom:5px; font-size:13px; font-weight:bold; color:#666; }
        input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; box-sizing:border-box; outline:none; background: #fff; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; transition: 0.2s; }
        .btn-save { background:var(--success); color:white; }
        .btn-compare { background:var(--primary); color:white; }

        #comparison-area { margin-top:15px; display:none; }
        .compare-card { background:#f0f7ff; border:1px solid #cce5ff; border-radius:16px; padding:15px; }
        .compare-item { background:white; border-radius:10px; padding:10px; margin-bottom:8px; border-left:4px solid #ddd; position:relative; }
        .compare-item.best-cp { border-left-color:var(--warning); background:#fffdf0; }
        .best-tag { position:absolute; right:10px; top:10px; background:var(--warning); color:#856404; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }

        .tab-headers { display:flex; gap:8px; overflow-x:auto; padding:15px 0; scrollbar-width:none; border-top: 1px solid #eee; margin-top: 20px; }
        .tab-btn { background:#eee; padding:8px 15px; border-radius:20px; white-space:nowrap; font-size:13px; font-weight:bold; cursor:pointer; }
        .tab-btn.active { background:var(--primary); color:white; }
        .record-item { background:#fff; padding:14px; border-radius:14px; margin-bottom:10px; border:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
        .record-price { text-align:right; font-weight:800; color:var(--primary); font-size:18px; }
        .ctrl-mini-btn { font-size:11px; padding:4px 8px; border-radius:6px; background:#f0f0f0; border:1px solid #ddd; cursor:pointer; margin-left:5px; }
    </style>
</head>
<body>
<div class="container">
    <div class="designer-credit">è¨­è¨ˆè€…ï¼šLai Ade</div>
    <h2 style="text-align:center; color:var(--primary); margin: 10px 0;">ğŸ›’ æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹ V4.5</h2>
    
    <div class="ocr-upload-zone" id="ocrTrigger">
        <span style="font-size:30px;">ğŸ“¸</span>
        <p style="margin:5px 0; font-weight:bold;">æ‹æ”åƒ¹æ ¼ç‰Œ</p>
        <input type="file" id="ocr-upload" accept="image/*" style="display:none">
        <span id="ocr-status" class="ocr-status">ç¡¬éæ¿¾æ©Ÿåˆ¶ï¼šå·²å•Ÿå‹• (å…é‡‘é‘°)</span>
    </div>

    <div class="input-group"><label>ğŸª å•†åº—åç¨±</label><input type="text" id="storeName" placeholder="ä¾‹å¦‚ï¼šå…¨è¯ã€å¥½å¸‚å¤š"></div>
    <div class="input-group"><label>ğŸ“¦ å•†å“åç¨±</label><input type="text" id="itemName" placeholder="è¾¨è­˜çµæœå°‡å‡ºç¾åœ¨æ­¤"></div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1.5;"><label>ğŸ’µ ç¸½åƒ¹ (å…ƒ)</label><input type="number" id="price" inputmode="decimal" placeholder="0" oninput="updateLivePrice()"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ”¢ æ•¸é‡</label><input type="number" id="count" value="1" inputmode="numeric" oninput="updateLivePrice()"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ“ å–®ä½</label><select id="unitSelect" onchange="handleUnitChange(this); updateLivePrice();"></select></div>
    </div>
    
    <div class="input-group"><label>ğŸ“ å‚™è¨»æ¬„</label><input type="text" id="remark" placeholder="è²·ä¸€é€ä¸€ç­‰"></div>

    <div class="btn-row">
        <button class="btn-save" id="btnSave">âœ… å„²å­˜</button>
        <button class="btn-compare" id="btnCompare">ğŸ” æ¯”åƒ¹</button>
    </div>

    <div id="comparison-area"><div class="compare-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h4 style="margin:0; color:#0056b3;">ğŸ“Š æ¯”åƒ¹åˆ†æçµæœ</h4>
            <span id="closeCompare" style="font-size:20px; cursor:pointer;">Ã—</span>
        </div>
        <div id="compareList"></div>
    </div></div>

    <div id="tab-headers" class="tab-headers"></div>
    <div id="store-controls" style="text-align:right; margin-bottom:10px;"></div>
    <div id="tab-contents"></div>

    <button id="btnClearAll" style="background:none; color:#999; font-size:11px; margin-top:20px; text-decoration:underline; border:none; width:auto; display:block; margin: 20px auto 0 auto;">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
</div>

<script>
let storeData = {}; let currentActiveStore = null;
const DEFAULT_UNITS = ["å…¥","é¡†","å€‹","å…‹","æ¯«å‡","c.c.","åŒ…","è¢‹","ç“¶","å…¬å‡"];

// --- ğŸ§± æ ¸å¿ƒï¼šç¡¬éæ¿¾é‚è¼¯ (Deterministic Filter) ---
function filterPriceCandidates(lines) {
    let candidates = [];
    const UNIT_PRICE_REGEX = /\d+\.?\d*\s*[å…ƒ\/]\s*(?:g|å…‹|ml|æ¯«å‡|ç‰‡|é¡†|å…¥)/i;
    const EXCLUDE_KEYWORDS = ["åŸåƒ¹", "å»ºè­°å”®åƒ¹", "çœä¸‹", "æŠ˜", "é»", "æ´»å‹•æœŸé–“"];

    lines.forEach(line => {
        const cleanLine = line.replace(/\s+/g, ""); 
        if (UNIT_PRICE_REGEX.test(cleanLine)) return; // æ–¬æ–·å–®ä½åƒ¹

        const numbers = cleanLine.match(/\d+/g);
        if (numbers) {
            numbers.forEach(numStr => {
                const val = parseInt(numStr);
                if (val < 10) return; // å¿½ç•¥æ¥µå°æ•¸å­—

                let score = 50;
                if (/å¹³å‡|ç‰¹åƒ¹|ä¿ƒéŠ·|ç¾åƒ¹|[\uff04$]/.test(cleanLine)) score += 50; // ç‰¹åƒ¹/å¹³å‡æ¬Šé‡åŠ æˆ
                if (EXCLUDE_KEYWORDS.some(k => cleanLine.includes(k))) score -= 60; // åŸåƒ¹é™æ¬Š

                candidates.push({ val, score, text: cleanLine });
            });
        }
    });
    return candidates.sort((a, b) => b.score - a.score || b.val - a.val);
}

// --- OCR åŸ·è¡Œ ---
async function performOCR(input) {
    if (!input.files[0]) return;
    const status = document.getElementById('ocr-status');
    status.innerText = "â³ ğŸ§± æ­£åœ¨åŸ·è¡Œç¡¬éæ¿¾è¾¨è­˜...";
    let worker;
    try {
        worker = await Tesseract.createWorker('chi_tra+eng');
        const { data } = await worker.recognize(input.files[0]);
        const lines = (data.lines || []).map(l => l.text.trim()).filter(Boolean);
        
        const priceResults = filterPriceCandidates(lines);
        let nameLines = lines.filter(l => /[\u4e00-\u9fa5]/.test(l) && !/^\d+$/.test(l)).slice(0, 2);

        document.getElementById('itemName').value = nameLines.join(' ');
        if (priceResults.length > 0) {
            document.getElementById('price').value = priceResults[0].val;
            status.innerText = "âœ… è¾¨è­˜æˆåŠŸ (å·²éæ¿¾å–®ä½åƒ¹èˆ‡åŸåƒ¹)";
        } else {
            status.innerText = "âš ï¸ è¾¨è­˜å®Œæˆï¼Œä½†æœªæ‰¾åˆ°æ˜ç¢ºåƒ¹æ ¼";
        }
        updateLivePrice();
    } catch(e) { status.innerText="âŒ è¾¨è­˜å¤±æ•—"; } 
    finally { if(worker) await worker.terminate(); }
}

// --- åŸºç¤é‚è¼¯ ---
function updateLivePrice() {
    const p = parseFloat(document.getElementById('price').value) || 0;
    const c = parseFloat(document.getElementById('count').value) || 1;
    const u = document.getElementById('unitSelect').value;
    if (p > 0) document.getElementById('ocr-status').innerText = `ğŸ’¡ å³æ™‚å–®åƒ¹ï¼š$${(p/c).toFixed(2)} / ${u}`;
}

function saveRecord() {
    const store = document.getElementById('storeName').value.trim() || "æœªåˆ†é¡å•†åº—";
    const name = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const count = parseInt(document.getElementById('count').value) || 1;
    const unit = document.getElementById('unitSelect').value;
    const remark = document.getElementById('remark').value.trim();

    if(!name || isNaN(price)) return alert("è«‹è¼¸å…¥æ­£ç¢ºå“åèˆ‡åƒ¹æ ¼");

    if(!storeData[store]) storeData[store] = [];
    storeData[store].push({name, price, count, unit, remark, date: new Date().toLocaleDateString()});
    localStorage.setItem('storeTabsData', JSON.stringify(storeData));
    renderTabs(store);
    document.getElementById('itemName').value = '';
    document.getElementById('price').value = '';
}

function renderTabs(activeStore = null) {
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    const controls = document.getElementById('store-controls');
    const storeNames = Object.keys(storeData);

    if (storeNames.length === 0) {
        contents.innerHTML = '<p style="text-align:center;color:#ccc;">å°šç„¡ç´€éŒ„</p>';
        return;
    }

    currentActiveStore = activeStore || storeNames[storeNames.length - 1];
    headers.innerHTML = storeNames.map(n => `<div class="tab-btn ${n === currentActiveStore ? 'active' : ''}" onclick="renderTabs('${n}')">${n}</div>`).join('');
    
    controls.innerHTML = `<span class="ctrl-mini-btn" style="color:red" onclick="deleteStore('${currentActiveStore}')">ğŸ—‘ï¸ åˆªé™¤æ­¤åº—</span>`;

    const records = storeData[currentActiveStore] || [];
    contents.innerHTML = records.slice().reverse().map((r, i) => {
        const unitP = r.price / r.count;
        return `<div class="record-item">
            <div>
                <b>${r.name}</b><br>
                <small>${r.date} Â· ${r.count}${r.unit} (å–®åƒ¹:${unitP.toFixed(2)})</small>
                ${r.remark ? `<div style="font-size:11px;color:#999 italic">å‚™è¨»: ${r.remark}</div>` : ''}
            </div>
            <div class="record-price">$${r.price}</div>
        </div>`;
    }).join('');
}

function deleteStore(name) { if(confirm(`ç¢ºå®šåˆªé™¤ ${name}ï¼Ÿ`)) { delete storeData[name]; localStorage.setItem('storeTabsData', JSON.stringify(storeData)); renderTabs(); } }

function refreshUnitSelect() {
    document.getElementById('unitSelect').innerHTML = DEFAULT_UNITS.map(u => `<option value="${u}">${u}</option>`).join('') + '<option value="ADD_NEW">â• æ–°å¢</option>';
}

function handleUnitChange(sel) { if(sel.value === "ADD_NEW") { const n = prompt("è¼¸å…¥æ–°å–®ä½:"); if(n) { DEFAULT_UNITS.push(n); refreshUnitSelect(); document.getElementById('unitSelect').value = n; } } }

window.onload = () => {
    storeData = JSON.parse(localStorage.getItem('storeTabsData')) || {};
    document.getElementById('ocrTrigger').onclick = () => document.getElementById('ocr-upload').click();
    document.getElementById('ocr-upload').onchange = e => performOCR(e.target);
    document.getElementById('btnSave').onclick = saveRecord;
    document.getElementById('btnCompare').onclick = () => alert("æ¯”åƒ¹åŠŸèƒ½èˆ‡ V3.6.1 ç›¸åŒï¼Œå°‡æœå°‹ç›¸ä¼¼å“åã€‚");
    document.getElementById('closeCompare').onclick = () => document.getElementById('comparison-area').style.display = 'none';
    document.getElementById('btnClearAll').onclick = () => { if(confirm("æ¸…ç©ºï¼Ÿ")) { localStorage.clear(); location.reload(); } };
    refreshUnitSelect();
    renderTabs();
};
</script>
</body>
</html>
