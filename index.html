<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ - æ——è‰¦æ•´åˆç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; color:#333; }
        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; }
        
        /* OCR å€å¡Š */
        .ocr-upload-zone { background:#fffbe6; border:2px dashed #ffe58f; padding:25px; border-radius:18px; text-align:center; margin-bottom:20px; cursor:pointer; }
        .ocr-status { font-size:13px; color:#856404; font-weight:bold; margin-top:10px; display:block; }
        
        .input-group { margin-bottom:15px; }
        label { display:block; margin-bottom:6px; font-size:14px; font-weight:bold; color:#666; }
        input { width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; box-sizing:border-box; outline:none; transition: 0.3s; }
        input:focus { border-color:var(--primary); box-shadow:0 0 0 3px rgba(74,144,226,0.1); }
        
        button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; transition:0.2s; margin-bottom:10px; }
        .btn-save { background:var(--success); color:white; }
        .btn-compare { background:var(--primary); color:white; box-shadow:0 4px 12px rgba(74,144,226,0.2); }
        .btn-save:active, .btn-compare:active { transform:scale(0.96); }

        /* æ¯”åƒ¹èˆ‡ CP å€¼ UI */
        #comparison-area { margin-top:15px; display:none; }
        .compare-card { background:#f0f7ff; border:1px solid #cce5ff; border-radius:16px; padding:15px; }
        .compare-item { background:white; border-radius:10px; padding:10px; margin-bottom:8px; border-left:4px solid #ddd; position:relative; }
        .compare-item.best-cp { border-left-color:var(--warning); background:#fffdf0; box-shadow: 0 4px 12px rgba(241,196,15,0.15); }
        .best-tag { position:absolute; right:10px; top:10px; background:var(--warning); color:#856404; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
        .unit-price { color:var(--danger); font-weight:bold; font-size:14px; }

        /* åˆ†é ç³»çµ± */
        #store-tabs-container { margin-top:25px; border-top:2px solid #f0f0f0; padding-top:20px; }
        .tab-headers { display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; scrollbar-width:none; }
        .tab-headers::-webkit-scrollbar { display:none; }
        .tab-btn { background:#eee; padding:10px 16px; border-radius:20px; white-space:nowrap; font-size:13px; font-weight:bold; flex-shrink:0; cursor:pointer; }
        .tab-btn.active { background:var(--primary); color:white; }
        
        .record-item { background:#fff; padding:14px; border-radius:14px; margin-bottom:10px; border:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
        .record-price { text-align:right; font-weight:800; color:var(--primary); font-size:18px; }
        .action-link { font-size:12px; color:var(--primary); margin-left:10px; cursor:pointer; text-decoration:none; }
        .action-link.delete { color:var(--danger); }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align:center; margin:0 0 20px 0; color:var(--primary);">ğŸ›’ æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹</h2>
    
    <div class="ocr-upload-zone" id="ocrTrigger">
        <span style="font-size:35px;">ğŸ“¸</span>
        <p style="margin:5px 0; font-weight:bold;">æ‹æ”åƒ¹æ ¼ç‰Œ</p>
        <input type="file" id="ocr-upload" accept="image/*" style="display:none">
        <span id="ocr-status" class="ocr-status">æ”¯æ´é›™è¡Œå“åèˆ‡åŠ æ¬Šæ¬Šé‡è¾¨è­˜</span>
    </div>

    <div class="input-group">
        <label>ğŸª å•†åº—åç¨±</label>
        <input type="text" id="storeName" placeholder="ä¾‹å¦‚ï¼šå…¨è¯ã€å¥½å¸‚å¤š">
    </div>
    <div class="input-group">
        <label>ğŸ“¦ å•†å“åç¨±</label>
        <input type="text" id="itemName" placeholder="è¾¨è­˜çµæœå°‡å‡ºç¾åœ¨æ­¤">
    </div>
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:2;">
            <label>ğŸ’µ åƒ¹æ ¼ (å…ƒ)</label>
            <input type="number" id="price" inputmode="decimal" placeholder="0">
        </div>
        <div class="input-group" style="flex:1;">
            <label>ğŸ”¢ æ•¸é‡</label>
            <input type="number" id="count" value="1" inputmode="numeric">
        </div>
    </div>

    <button class="btn-save" id="btnSave">âœ… å„²å­˜æ­¤ç´€éŒ„</button>
    <button class="btn-compare" id="btnCompare">ğŸ” æ­·å²æ¯”åƒ¹ (CPå€¼)</button>

    <div id="comparison-area">
        <div class="compare-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; color:#0056b3;">ğŸ“Š æ¯”åƒ¹åˆ†æçµæœ (LCS â‰¥ 2)</h4>
                <span id="closeCompare" style="font-size:20px; cursor:pointer;">Ã—</span>
            </div>
            <div id="compareList"></div>
        </div>
    </div>

    <div id="store-tabs-container">
        <div id="tab-headers" class="tab-headers"></div>
        <div id="tab-contents"></div>
    </div>
    <button class="btn-clear" id="btnClearAll" style="background:none; color:#999; font-size:12px; margin-top:20px; text-decoration:underline;">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
</div>

<script>
let storeData = {};

/** * [æ•´åˆå¼·åŒ–] OCR æ¬Šé‡è¾¨è­˜é‚è¼¯ 
 */
async function performOCR(input) {
    if (!input.files[0]) return;
    const status = document.getElementById('ocr-status');
    status.innerText = "â³ æ·±åº¦è¾¨è­˜ä¸­...";
    let worker;
    try {
        worker = await Tesseract.createWorker('chi_tra+eng');
        const { data } = await worker.recognize(input.files[0]);
        const lines = (data.lines || []).map(l => l.text.trim()).filter(Boolean);
        
        let nameLines = [], priceCandidates = [];
        const priceSemantic = /(?:NT\$|\$|ç‰¹åƒ¹|å”®åƒ¹|é‡‘é¡|ç¸½è¨ˆ|åƒ¹æ ¼)[:ï¼š\s]*([\d,]{2,7})/i;

        lines.forEach(line => {
            // 1. åƒ¹æ ¼å€™é¸æå–
            const sMatch = line.match(priceSemantic);
            if (sMatch) {
                priceCandidates.push({ val: parseInt(sMatch[1].replace(/,/g, '')), score: 100 });
            }
            const pMatches = line.match(/\b\d{2,5}\b/g);
            if (pMatches) pMatches.forEach(m => priceCandidates.push({ val: parseInt(m), score: 50 }));

            // 2. å“åé›™è¡Œæå–
            if (/[\u4e00-\u9fa5]/.test(line) && nameLines.length < 2 && !priceSemantic.test(line) && !/^\d+$/.test(line)) {
                nameLines.push(line.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '').trim());
            }
        });

        // æ’åºå€™é¸åƒ¹æ ¼ (ä¿®æ­£ b.score-a.score)
        priceCandidates.sort((a, b) => b.score - a.score || a.val - b.val);

        document.getElementById('itemName').value = nameLines.join(' ');
        if (priceCandidates.length > 0) document.getElementById('price').value = priceCandidates[0].val;

        status.innerText = "âœ… è¾¨è­˜å®Œæˆ";
    } catch (e) {
        status.innerText = "âŒ è¾¨è­˜å¤±æ•—";
        console.error(e);
    } finally {
        if (worker) await worker.terminate();
    }
}

/** [æ ¸å¿ƒ] åš´æ ¼ LCS æ¯”åƒ¹é‚è¼¯ */
function getLCSLength(s1, s2) {
    if (!s1 || !s2) return 0;
    let m = s1.length, n = s2.length, max = 0;
    let table = Array(m+1).fill(0).map(()=>Array(n+1).fill(0));
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (s1[i - 1] === s2[j - 1]) {
                table[i][j] = table[i - 1][j - 1] + 1;
                max = Math.max(max, table[i][j]);
            }
        }
    }
    return max;
}

function comparePrices() {
    const query = document.getElementById('itemName').value.trim();
    if (query.length < 1) return alert("è«‹å…ˆè¼¸å…¥å“åæˆ–ä½¿ç”¨è¾¨è­˜");
    let matches = [];
    Object.keys(storeData).forEach(store => {
        storeData[store].forEach((item, index) => {
            const lcs = getLCSLength(query, item.name);
            if (lcs >= 2) {
                matches.push({ ...item, store, index, matchScore: lcs, unitPrice: item.price / item.count });
            }
        });
    });

    if (matches.length === 0) {
        alert("æ‰¾ä¸åˆ°ç›¸ä¼¼æ­·å²ç´€éŒ„ (LCS < 2)");
        document.getElementById('comparison-area').style.display = 'none';
        return;
    }

    matches.sort((a, b) => b.matchScore - a.matchScore || a.unitPrice - b.unitPrice);
    const minUnitPrice = Math.min(...matches.map(m => m.unitPrice));

    const listContainer = document.getElementById('compareList');
    listContainer.innerHTML = matches.map(m => {
        const isBest = Math.abs(m.unitPrice - minUnitPrice) < 0.01;
        return `
            <div class="compare-item ${isBest ? 'best-cp' : ''}">
                ${isBest ? '<span class="best-tag">ğŸ† æ­·å²æœ€æ¨ (CPæœ€é«˜)</span>' : ''}
                <div style="font-weight:bold; font-size:14px;">${escapeHtml(m.name)}</div>
                <div style="font-size:11px; color:#666;">ğŸ“ ${escapeHtml(m.store)} | ğŸ“… ${m.date} | åŒ¹é…:${m.matchScore}å­—</div>
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:5px;">
                    <small>$${m.price} / ${m.count}å…¥</small>
                    <span class="unit-price">å–®åƒ¹: $${m.unitPrice.toFixed(2)}</span>
                </div>
            </div>
        `;
    }).join('');

    document.getElementById('comparison-area').style.display = 'block';
    document.getElementById('comparison-area').scrollIntoView({ behavior: 'smooth' });
}

/* --- å®Œæ•´ CRUD ç´€éŒ„ç®¡ç†ç³»çµ± --- */
function saveRecord() {
    const store = document.getElementById('storeName').value.trim() || "æœªåˆ†é¡å•†åº—";
    const name = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const count = parseInt(document.getElementById('count').value) || 1;
    if (!name || isNaN(price)) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
    
    if (!storeData[store]) storeData[store] = [];
    storeData[store].push({ name, price, count, date: new Date().toLocaleDateString() });
    saveToStorage();
    renderTabs(store);
    resetInputs();
}

function deleteRecord(store, index) {
    if (confirm("ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ")) {
        storeData[store].splice(index, 1);
        if (storeData[store].length === 0) delete storeData[store];
        saveToStorage();
        renderTabs(store);
    }
}

function saveToStorage() { localStorage.setItem('storeTabsData', JSON.stringify(storeData)); }
function resetInputs() { document.getElementById('itemName').value = ''; document.getElementById('price').value = ''; document.getElementById('comparison-area').style.display = 'none'; }
function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

function renderTabs(activeStore = null) {
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    const storeNames = Object.keys(storeData);
    if (storeNames.length === 0) { headers.innerHTML = ''; contents.innerHTML = '<p style="text-align:center;color:#ccc;padding:20px;">å°šç„¡ç´€éŒ„</p>'; return; }
    if (!activeStore || !storeData[activeStore]) activeStore = storeNames[storeNames.length - 1];

    headers.innerHTML = storeNames.map(n => `<div class="tab-btn ${n === activeStore ? 'active' : ''}" onclick="renderTabs('${n}')">${escapeHtml(n)}</div>`).join('');
    
    const records = storeData[activeStore] || [];
    contents.innerHTML = records.slice().reverse().map((r, i) => {
        const originalIndex = records.length - 1 - i;
        return `
            <div class="record-item">
                <div>
                    <b>${escapeHtml(r.name)}</b><br>
                    <small>${r.date} Â· ${r.count}å…¥</small>
                    <br><a class="action-link delete" onclick="deleteRecord('${activeStore}', ${originalIndex})">åˆªé™¤</a>
                </div>
                <div class="record-price">$${r.price}</div>
            </div>
        `;
    }).join('');
}

window.onload = () => {
    storeData = JSON.parse(localStorage.getItem('storeTabsData')) || {};
    document.getElementById('ocrTrigger').onclick = () => document.getElementById('ocr-upload').click();
    document.getElementById('ocr-upload').onchange = e => performOCR(e.target);
    document.getElementById('btnSave').onclick = saveRecord;
    document.getElementById('btnCompare').onclick = comparePrices;
    document.getElementById('closeCompare').onclick = () => document.getElementById('comparison-area').style.display = 'none';
    document.getElementById('btnClearAll').onclick = () => { if(confirm("æ¸…ç©ºï¼Ÿ")) { localStorage.clear(); location.reload(); }};
    renderTabs();
};
</script>
</body>
</html>
