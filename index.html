<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ - V3.6 ğŸ”’</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; color:#333; }
        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; }
        .ocr-upload-zone { background:#fffbe6; border:2px dashed #ffe58f; padding:25px; border-radius:18px; text-align:center; margin-bottom:20px; cursor:pointer; }
        .ocr-status { font-size:13px; color:#856404; font-weight:bold; margin-top:10px; display:block; }
        .input-group { margin-bottom:15px; }
        label { display:block; margin-bottom:6px; font-size:14px; font-weight:bold; color:#666; }
        input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; box-sizing:border-box; outline:none; background: white; }
        button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; margin-bottom:10px; transition: 0.2s; }
        .btn-save { background:var(--success); color:white; }
        .btn-compare { background:var(--primary); color:white; }
        #comparison-area { margin-top:15px; display:none; }
        .compare-card { background:#f0f7ff; border:1px solid #cce5ff; border-radius:16px; padding:15px; }
        .compare-item { background:white; border-radius:10px; padding:10px; margin-bottom:8px; border-left:4px solid #ddd; position:relative; }
        .compare-item.best-cp { border-left-color:var(--warning); background:#fffdf0; }
        .best-tag { position:absolute; right:10px; top:10px; background:var(--warning); color:#856404; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
        #store-tabs-container { margin-top:25px; border-top:2px solid #f0f0f0; padding-top:20px; }
        .tab-controls { display:flex; gap:8px; margin-bottom:10px; justify-content: flex-end; }
        .tab-headers { display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; scrollbar-width:none; }
        .tab-btn { background:#eee; padding:10px 16px; border-radius:20px; white-space:nowrap; font-size:13px; font-weight:bold; flex-shrink:0; cursor:pointer; }
        .tab-btn.active { background:var(--primary); color:white; }
        .record-item { background:#fff; padding:14px; border-radius:14px; margin-bottom:10px; border:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
        .record-price { text-align:right; font-weight:800; color:var(--primary); font-size:18px; }
        .action-link { font-size:12px; color:var(--primary); margin-right:12px; cursor:pointer; text-decoration: none; font-weight: bold; }
        .action-link.delete { color:var(--danger); }
        .remark-text { font-size: 11px; color: #888; margin-top: 3px; font-style: italic; }
        .ctrl-mini-btn { font-size:11px; padding:5px 10px; border-radius:8px; background:#f0f0f0; border:1px solid #ddd; cursor:pointer; }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align:center; margin:0 0 20px 0; color:var(--primary);">ğŸ›’ æ——è‰¦æ¯”åƒ¹åŠ©æ‰‹ (V3.6)</h2>
    
    <div class="ocr-upload-zone" id="ocrTrigger">
        <span style="font-size:35px;">ğŸ“¸</span>
        <p style="margin:5px 0; font-weight:bold;">æ‹æ”åƒ¹æ ¼ç‰Œ</p>
        <input type="file" id="ocr-upload" accept="image/*" style="display:none">
        <span id="ocr-status" class="ocr-status">æ”¯æ´ V3.6 æœ€å°å–®ä½åƒ¹æ ¼è¨ˆç®—</span>
    </div>

    <div class="input-group">
        <label>ğŸª å•†åº—åç¨±</label>
        <input type="text" id="storeName" placeholder="ä¾‹å¦‚ï¼šå…¨è¯ã€å¥½å¸‚å¤š">
    </div>
    <div class="input-group">
        <label>ğŸ“¦ å•†å“åç¨±</label>
        <input type="text" id="itemName" placeholder="è¾¨è­˜çµæœå°‡å‡ºç¾åœ¨æ­¤">
    </div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1.5;">
            <label>ğŸ’µ ç¸½åƒ¹ (å…ƒ)</label>
            <input type="number" id="price" inputmode="decimal" placeholder="0">
        </div>
        <div class="input-group" style="flex:1;">
            <label>ğŸ”¢ æ•¸é‡</label>
            <input type="number" id="count" value="1" inputmode="numeric">
        </div>
        <div class="input-group" style="flex:1;">
            <label>ğŸ“ å–®ä½</label>
            <select id="unitSelect" onchange="handleUnitChange(this)"></select>
        </div>
    </div>

    <div class="input-group">
        <label>ğŸ“ å‚™è¨»æ¬„</label>
        <input type="text" id="remark" placeholder="è²·ä¸€é€ä¸€ç­‰">
    </div>

    <button class="btn-save" id="btnSave">âœ… å„²å­˜æ­¤ç´€éŒ„</button>
    <button class="btn-compare" id="btnCompare">ğŸ” æ­·å²æ¯”åƒ¹ (CPå€¼)</button>

    <div id="comparison-area">
        <div class="compare-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; color:#0056b3;">ğŸ“Š æ¯”åƒ¹åˆ†æçµæœ (LCS â‰¥ 2)</h4>
                <span id="closeCompare" style="font-size:20px; cursor:pointer;">Ã—</span>
            </div>
            <div id="compareList"></div>
        </div>
    </div>

    <div id="store-tabs-container">
        <div id="tab-controls" class="tab-controls"></div>
        <div id="tab-headers" class="tab-headers"></div>
        <div id="tab-contents"></div>
    </div>
    <button id="btnClearAll" style="background:none; color:#999; font-size:12px; margin-top:20px; text-decoration:underline; border:none; width:auto; display:block; margin: 20px auto 0 auto;">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
</div>

<script>
let storeData = {};
let currentActiveStore = null;
let unitList = [];
let editingIndex = null; 
const DEFAULT_UNITS = ["å…¥","é¡†","å€‹","å…‹","æ¯«å‡","c.c.","åŒ…","è¢‹","ç“¶","å…¬å‡"];

/* ğŸ›¡ï¸ V3.5.x æ ¸å¿ƒè¾¨è­˜å¼•æ“ (ç¶­æŒé–å®š) */
function ocrPostProcessor(text) {
    if (!text) return "";
    let processed = text.replace(/[\uFF01-\uFF5E]/g, (ch) => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    processed = processed.replace(/ã€€/g, " "); 
    processed = processed.replace(/é½Š\s*å‡/g, "æ¯«å‡"); 
    processed = processed.replace(/(\d)\s*äºº/g, "$1å…¥");
    const chineseSpaceRegex = /([\u4e00-\u9fa5])\s+([\u4e00-\u9fa5])/g;
    processed = processed.replace(chineseSpaceRegex, "$1$2").replace(chineseSpaceRegex, "$1$2");
    return processed.trim();
}

async function performOCR(input) {
    if (!input.files[0]) return;
    const status = document.getElementById('ocr-status');
    status.innerText = "â³ æ·±åº¦è¾¨è­˜ä¸­...";
    let worker;
    try {
        worker = await Tesseract.createWorker('chi_tra+eng');
        const { data } = await worker.recognize(input.files[0]);
        const lines = (data.lines || []).map(l => l.text.trim()).filter(Boolean);
        let nameLines = [], priceCandidates = [];
        const priceSemantic = /(?:NT\$|\$|ç‰¹åƒ¹|å”®åƒ¹|é‡‘é¡|ç¸½è¨ˆ|åƒ¹æ ¼)[:ï¼š\s]*([\d,]{2,7})/i;
        
        lines.forEach(line => {
            const cleanLine = ocrPostProcessor(line);
            const sMatch = cleanLine.match(priceSemantic);
            if (sMatch) priceCandidates.push({ val: parseInt(sMatch[1].replace(/,/g, '')), score: 100 });
            const pMatches = cleanLine.match(/\b\d{2,5}\b/g);
            if (pMatches) pMatches.forEach(m => { const v = parseInt(m); if (v > 15) priceCandidates.push({ val: v, score: 50 }); });
            if (/[\u4e00-\u9fa5]/.test(cleanLine) && nameLines.length < 2 && !priceSemantic.test(cleanLine) && !/^\d+$/.test(cleanLine)) {
                nameLines.push(cleanLine.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '').trim());
            }
        });
        priceCandidates.sort((a,b)=>b.score - a.score || a.val - b.val);
        document.getElementById('itemName').value = nameLines.join(' ');
        if (priceCandidates.length > 0) document.getElementById('price').value = priceCandidates[0].val;
        status.innerText = "âœ… è¾¨è­˜èˆ‡æ ¡æ­£å®Œæˆ";
    } catch(e){ status.innerText="âŒ è¾¨è­˜å¤±æ•—"; } finally { if(worker) await worker.terminate(); }
}

/* ğŸ” æ¯”åƒ¹æ ¸å¿ƒ (LCS) - ç¶­æŒé–å®š */
function getLCSLength(s1,s2){
    if(!s1||!s2)return 0;
    let m=s1.length,n=s2.length,max=0;
    let table=Array(m+1).fill(0).map(()=>Array(n+1).fill(0));
    for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
            if(s1[i-1]===s2[j-1]){ table[i][j]=table[i-1][j-1]+1; max=Math.max(max,table[i][j]); }
        }
    }
    return max;
}

function comparePrices(){
    const query=document.getElementById('itemName').value.trim();
    const currentUnit=document.getElementById('unitSelect').value;
    if(query.length<1)return alert("è«‹å…ˆè¼¸å…¥å“å");
    let matches=[];
    Object.keys(storeData).forEach(store=>{
        storeData[store].forEach((item,index)=>{
            const lcs=getLCSLength(query, item.name);
            if(lcs>=2)matches.push({...item,store,index,matchScore:lcs,unitPrice:item.price/(item.count||1)});
        });
    });
    if(matches.length===0)return alert("æ‰¾ä¸åˆ°ç›¸ä¼¼ç´€éŒ„");
    matches.sort((a,b)=>b.matchScore-a.matchScore||a.unitPrice-b.unitPrice);
    const sameUnitMatches=matches.filter(m=>(m.unit||'å…¥')===currentUnit);
    const minUnitPrice=sameUnitMatches.length>0?Math.min(...sameUnitMatches.map(m=>m.unitPrice)):null;
    const listContainer=document.getElementById('compareList');
    listContainer.innerHTML=matches.map(m=>{
        const itemUnit=m.unit||'å…¥';
        const isBest=(itemUnit===currentUnit)&&minUnitPrice&&Math.abs(m.unitPrice-minUnitPrice)<0.01;
        return `<div class="compare-item ${isBest?'best-cp':''}">
            ${isBest?'<span class="best-tag">ğŸ† åŒå–®ä½æœ€é«˜CP</span>':''}
            <div style="font-weight:bold; font-size:14px;">${escapeHtml(m.name)}</div>
            <div style="font-size:11px; color:#666;">ğŸ“ ${escapeHtml(m.store)} | $${m.price} (${m.count}${itemUnit})</div>
        </div>`;
    }).join('');
    document.getElementById('comparison-area').style.display='block';
}

/* ğŸ“ åˆ†é èˆ‡å•†å“ç®¡ç† (CRUD) - ç¶­æŒé–å®š */
function renameStore(oldName) {
    const newName = prompt("å°‡ã€Œ" + oldName + "ã€é‡æ–°å‘½åç‚ºï¼š", oldName);
    if (newName && newName.trim() && newName !== oldName) {
        if (storeData[newName]) return alert("æ­¤åº—åå·²å­˜åœ¨ï¼");
        storeData[newName.trim()] = storeData[oldName];
        delete storeData[oldName];
        saveToStorage();
        renderTabs(newName.trim());
    }
}

function deleteStore(storeName) {
    if (confirm("ç¢ºå®šåˆªé™¤å•†åº—ã€Œ" + storeName + "ã€åŠå…¶å…§å®¹ï¼Ÿ")) {
        delete storeData[storeName];
        saveToStorage();
        renderTabs();
    }
}

function editItem(store, index) {
    const item = storeData[store][index];
    document.getElementById('storeName').value = store;
    document.getElementById('itemName').value = item.name;
    document.getElementById('price').value = item.price;
    document.getElementById('count').value = item.count;
    document.getElementById('remark').value = item.remark || '';
    refreshUnitSelect(item.unit);
    editingIndex = { store, index };
    const btn = document.getElementById('btnSave');
    btn.innerText = "ğŸ†™ æ›´æ–°ç´€éŒ„ (å–ä»£åŸé …ç›®)";
    btn.style.background = "var(--primary)";
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function saveRecord(){
    const store=document.getElementById('storeName').value.trim()||"æœªåˆ†é¡å•†åº—";
    const name=document.getElementById('itemName').value.trim();
    const price=parseFloat(document.getElementById('price').value);
    const count=parseInt(document.getElementById('count').value)||1;
    const unit=document.getElementById('unitSelect').value;
    const remark=document.getElementById('remark').value.trim();
    if(!name||isNaN(price)) return alert("è«‹è¼¸å…¥æ­£ç¢ºå“åèˆ‡åƒ¹æ ¼");

    if (editingIndex) {
        storeData[editingIndex.store].splice(editingIndex.index, 1);
        if (storeData[editingIndex.store].length === 0) delete storeData[editingIndex.store];
        editingIndex = null;
        document.getElementById('btnSave').innerText = "âœ… å„²å­˜æ­¤ç´€éŒ„";
        document.getElementById('btnSave').style.background = "var(--success)";
    }
    
    if(!storeData[store]) storeData[store]=[];
    storeData[store].push({name,price,count,unit,remark,date:new Date().toLocaleDateString()});
    saveToStorage();
    renderTabs(store);
    resetInputs();
}

/* ğŸ¯æœ¬æ¬¡å”¯ä¸€ä¿®æ”¹ç¯„åœï¼šrenderTabs å…§éƒ¨æ¨¡æ¿ï¼Œæ–°å¢å–®åƒ¹é¡¯ç¤º */
function renderTabs(activeStore=null){
    currentActiveStore = activeStore;
    const controls = document.getElementById('tab-controls');
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    const storeNames = Object.keys(storeData);
    if(storeNames.length === 0){
        controls.innerHTML = ''; headers.innerHTML = ''; contents.innerHTML = '<p style="text-align:center;color:#ccc;padding:20px;">å°šç„¡ç´€éŒ„</p>';
        return;
    }
    if(!currentActiveStore || !storeData[currentActiveStore]) currentActiveStore = storeNames[storeNames.length-1];
    
    controls.innerHTML = `<span class="ctrl-mini-btn" onclick="renameStore('${currentActiveStore}')">ğŸ“ æ”¹åº—å</span><span class="ctrl-mini-btn" style="color:var(--danger)" onclick="deleteStore('${currentActiveStore}')">ğŸ—‘ï¸ åˆªé™¤åº—</span>`;
    headers.innerHTML = storeNames.map(n => `<div class="tab-btn ${n === currentActiveStore ? 'active' : ''}" onclick="renderTabs('${n}')">${escapeHtml(n)}</div>`).join('');
    
    const records = storeData[currentActiveStore] || [];
    contents.innerHTML = records.slice().reverse().map((r, i) => {
        const originalIndex = records.length - 1 - i;
        // è¨ˆç®—æœ€å°å–®ä½åƒ¹æ ¼é‚è¼¯
        const unitP = r.price / (r.count || 1);
        return `<div class="record-item">
            <div style="flex:1">
                <b>${escapeHtml(r.name)} (${escapeHtml(r.unit)})</b><br>
                <small>${r.date} Â· ${r.count}${escapeHtml(r.unit)} (å–®åƒ¹: ${unitP.toFixed(2)} / ${escapeHtml(r.unit)})</small>
                ${r.remark ? `<div class="remark-text">å‚™è¨»: ${escapeHtml(r.remark)}</div>` : ''}
                <div style="margin-top:8px;">
                    <span class="action-link" onclick="editItem('${currentActiveStore}', ${originalIndex})">âœï¸ ç·¨è¼¯</span>
                    <span class="action-link delete" onclick="deleteRecord('${currentActiveStore}', ${originalIndex})">ğŸ—‘ï¸ åˆªé™¤</span>
                </div>
            </div>
            <div class="record-price">$${r.price}</div>
        </div>`;
    }).join('');
}

/* ğŸ“ å–®ä½èˆ‡å­˜å„²è¼”åŠ© - ç¶­æŒé–å®š */
function refreshUnitSelect(targetValue = null) {
    const sel = document.getElementById('unitSelect');
    let usedUnits = [];
    Object.values(storeData).forEach(sItems => sItems.forEach(i => { if(i.unit) usedUnits.push(i.unit); }));
    let combined = Array.from(new Set([...DEFAULT_UNITS, ...unitList, ...usedUnits]));
    sel.innerHTML = combined.map(u => `<option value="${u}" ${u === targetValue ? 'selected' : ''}>${u}</option>`).join('') + `<option value="ADD_NEW">â• æ–°å¢...</option>`;
}

function handleUnitChange(sel) {
    if (sel.value === "ADD_NEW") {
        const n = prompt("è¼¸å…¥æ–°å–®ä½:");
        if (n && n.trim()) {
            unitList.push(n.trim());
            localStorage.setItem('managedUnits', JSON.stringify(unitList));
            refreshUnitSelect(n.trim());
        }
    }
}

function deleteRecord(store,index){
    if(confirm("ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ")){
        storeData[store].splice(index,1);
        if(storeData[store].length===0) delete storeData[store];
        saveToStorage();
        renderTabs(storeData[store] ? store : null);
    }
}

function saveToStorage(){ localStorage.setItem('storeTabsData',JSON.stringify(storeData)); }
function resetInputs(){
    document.getElementById('itemName').value='';
    document.getElementById('price').value='';
    document.getElementById('remark').value='';
    document.getElementById('count').value='1';
    document.getElementById('comparison-area').style.display='none';
}
function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

window.onload=()=>{
    unitList=JSON.parse(localStorage.getItem('managedUnits'))||[];
    storeData=JSON.parse(localStorage.getItem('storeTabsData'))||{};
    document.getElementById('ocrTrigger').onclick=()=>document.getElementById('ocr-upload').click();
    document.getElementById('ocr-upload').onchange=e=>performOCR(e.target);
    document.getElementById('btnSave').onclick=saveRecord;
    document.getElementById('btnCompare').onclick=comparePrices;
    document.getElementById('closeCompare').onclick=()=>document.getElementById('comparison-area').style.display='none';
    document.getElementById('btnClearAll').onclick=()=> {if(confirm("æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ")){localStorage.clear(); location.reload();}};
    refreshUnitSelect();
    renderTabs();
};
</script>
</body>
</html>
