async function performOCR(input) {
        if (!input.files || !input.files[0]) return;
        const status = document.getElementById('ocr-status');
        status.innerText = "⌛ 辨識中...";
        
        try {
            const r = await Tesseract.recognize(input.files[0], 'chi_tra+jpn+eng');
            const lines = r.data.text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            // --- 價格處理：獨立語意實體判定 ---
            let priceCandidates = [];
            // 只匹配獨立的 1-5 位數字，排除緊貼英文字母的型號
            const strictPriceRegex = /(?:^|[\s$¥]|NT\$|價[:：])(\d{1,5}(?:[.,]\d{1,2})?)(?:\s|$)/i;

            lines.forEach(line => {
                const match = line.match(strictPriceRegex);
                if (match) {
                    const val = parseFloat(match[1].replace(/,/g, ''));
                    let score = /[$¥]|NT\$/i.test(line) ? 200 : 50;
                    if (/特價|售價|優惠/i.test(line)) score += 100;
                    if (/原價|定價/i.test(line)) score += 20; // 優先級低於特價
                    if (/編號|No|碼|Tel|日期|202\d|Exp/i.test(line)) score -= 500;
                    priceCandidates.push({ val, score, line });
                }
            });
            const bestPrice = priceCandidates.sort((a,b) => b.score - a.score)[0];
            if (bestPrice && bestPrice.score > -100) document.getElementById('price').value = bestPrice.val;

            // --- 名稱處理：區段連續合併與即時終止 ---
            const blacklist = ['公司', '產地', '地址', '保存', '日期', '有效', 'Tel', '成分', '網址', '總計', 'Total'];
            let nameBuffer = [];
            let stopMerging = false;

            for (let line of lines) {
                if (stopMerging) break;

                const isPriceLine = strictPriceRegex.test(line);
                const textOnly = line.replace(/[\d\s,.$¥NT:：xX*＊\-/]/g, '');
                const ratio = line.length > 0 ? textOnly.length / line.length : 0;
                const isBlacklisted = blacklist.some(word => line.includes(word));

                // 合併規則：文字比例達標且不是價格行、不是黑名單
                if (!isBlacklisted && !isPriceLine && ratio > 0.4 && line.length > 1) {
                    nameBuffer.push(line.replace(/[$¥NT\d,.]+$/g, '').trim());
                } else {
                    // 終止條件：一旦品名區段開始後遇到不符條件的行，即停止合併
                    if (nameBuffer.length > 0) stopMerging = true;
                }
            }

            if (nameBuffer.length > 0) {
                document.getElementById('itemName').value = nameBuffer.join(' ');
            }
            
            status.innerText = "✅ 辨識完成";
            calculate(); updateHistory();
        } catch (e) {
            status.innerText = "❌ 辨識失敗";
        }
    }
