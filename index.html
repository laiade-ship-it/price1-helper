<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ - V3.6.1 Pro ğŸ”’</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; color:#333; }
        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; }
        
        /* ğŸ“¸ å¤šåœ–ä¸Šå‚³å€ */
        .photo-upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .photo-slot { aspect-ratio: 1; border: 2px dashed #ddd; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; background: #fafafa; overflow: hidden; font-size: 24px; color: #ccc; }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        .photo-slot .remove-p { position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.7); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 14px; text-align: center; line-height: 20px; font-weight: bold; }
        
        .input-group { margin-bottom:12px; }
        label { display:block; margin-bottom:4px; font-size:13px; font-weight:bold; color:#666; }
        input, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:15px; box-sizing:border-box; outline: none; }
        button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; margin-bottom:10px; }
        .btn-save { background:var(--success); color:white; }

        /* ğŸ–¼ï¸ å¤§åœ–é è¦½ç‡ˆç®± */
        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; cursor: pointer; }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* ç´€éŒ„å‘ˆç¾ */
        .record-item { background:#fff; padding:15px; border-radius:16px; margin-bottom:12px; border:1px solid #eee; position: relative; }
        .record-photos { display: flex; gap: 8px; margin-top: 10px; }
        .record-photos img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; cursor: zoom-in; }
        .tab-btn { background:#eee; padding:8px 16px; border-radius:20px; font-size:13px; cursor:pointer; white-space:nowrap; font-weight:bold; }
        .tab-btn.active { background:var(--primary); color:white; }
        .tab-headers { display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; margin-top: 10px; }
        .action-link { font-size:12px; color:var(--primary); margin-right:12px; cursor:pointer; font-weight:bold; }
    </style>
</head>
<body>

<div id="lightbox" onclick="this.style.display='none'"><img id="lightbox-img" src=""></div>

<div class="container">
    <h2 style="text-align:center; color:var(--primary); margin:0 0 20px 0;">ğŸ›’ æ——è‰¦æ¯”åƒ¹ V3.6.1</h2>

    <label>ğŸ“¸ å•†å“ç…§ç‰‡ (ç¬¬1å¼µåœ–å°‡è‡ªå‹•è¾¨è­˜å“å)</label>
    <div class="photo-upload-grid">
        <div class="photo-slot" onclick="triggerFile(0)" id="slot-0">+</div>
        <div class="photo-slot" onclick="triggerFile(1)" id="slot-1">+</div>
        <div class="photo-slot" onclick="triggerFile(2)" id="slot-2">+</div>
    </div>
    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">

    <div class="input-group"><label>ğŸª å•†åº—åç¨±</label><input type="text" id="storeName" placeholder="ä¾‹å¦‚ï¼šå…¨è¯"></div>
    <div class="input-group"><label>ğŸ“¦ å•†å“åç¨±</label><input type="text" id="itemName" placeholder="è¾¨è­˜çµæœå°‡å‡ºç¾åœ¨æ­¤"></div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:2;"><label>ğŸ’µ ç¸½åƒ¹</label><input type="number" id="price" inputmode="decimal"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ”¢ æ•¸é‡</label><input type="number" id="count" value="1"></div>
        <div class="input-group" style="flex:1.2;"><label>ğŸ“ å–®ä½</label><select id="unitSelect" onchange="handleUnitChange(this)"></select></div>
    </div>

    <button class="btn-save" id="btnSave" onclick="saveRecord()">âœ… å„²å­˜æ­¤ç´€éŒ„</button>

    <div id="store-tabs-container" style="border-top: 2px solid #f0f0f0; padding-top: 15px;">
        <div id="tab-controls" style="display:flex; justify-content:flex-end; gap:10px;"></div>
        <div id="tab-headers" class="tab-headers"></div>
        <div id="tab-contents"></div>
    </div>
</div>

<script>
let storeData = {}; 
let unitList = [];
let currentPhotos = [null, null, null];
let editingTarget = null;
let currentSlotIndex = 0;
const DEFAULT_UNITS = ["å…¥","é¡†","å€‹","å…‹","æ¯«å‡","c.c.","åŒ…","è¢‹","ç“¶","å…¬å‡"];

// --- ğŸ“¸ ç…§ç‰‡è™•ç†èˆ‡ç‡ˆç®± ---
function triggerFile(index) {
    currentSlotIndex = index;
    document.getElementById('file-input').click();
}

async function handleFile(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    if (currentSlotIndex === 0) performOCR(file); // åƒ…ç¬¬ä¸€å¼µåœ–è·‘OCR
    const base64 = await compressImage(file);
    currentPhotos[currentSlotIndex] = base64;
    renderPhotoSlots();
    input.value = ""; // æ¸…ç©ºï¼Œè®“åŒä¸€å¼µåœ–å¯ä»¥é‡è¤‡é¸
}

function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const max_size = 500; 
                let w = img.width, h = img.height;
                if (w > h) { if (w > max_size) { h *= max_size / w; w = max_size; } }
                else { if (h > max_size) { w *= max_size / h; h = max_size; } }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
        };
    });
}

function openLightbox(src) {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').style.display = 'flex';
}

function renderPhotoSlots() {
    currentPhotos.forEach((data, i) => {
        const slot = document.getElementById(`slot-${i}`);
        if (data) {
            slot.innerHTML = `<img src="${data}"><div class="remove-p" onclick="event.stopPropagation();removePhoto(${i})">Ã—</div>`;
        } else {
            slot.innerHTML = `+`;
        }
    });
}

function removePhoto(i) {
    currentPhotos[i] = null;
    renderPhotoSlots();
}

// --- ğŸ“ å–®ä½ç®¡ç† ---
function refreshUnitSelect(targetValue = null) {
    const sel = document.getElementById('unitSelect');
    const combined = Array.from(new Set([...DEFAULT_UNITS, ...unitList]));
    sel.innerHTML = combined.map(u => `<option value="${u}" ${u === targetValue ? 'selected' : ''}>${u}</option>`).join('') + `<option value="ADD_NEW">â• æ–°å¢...</option>`;
}

function handleUnitChange(sel) {
    if (sel.value === "ADD_NEW") {
        const n = prompt("è«‹è¼¸å…¥æ–°å–®ä½åç¨±ï¼š");
        if (n && n.trim()) {
            unitList.push(n.trim());
            localStorage.setItem('managedUnits', JSON.stringify(unitList));
            refreshUnitSelect(n.trim());
        } else {
            sel.selectedIndex = 0;
        }
    }
}

// --- ğŸ’¾ æ ¸å¿ƒå„²å­˜é‚è¼¯ ---
function saveRecord() {
    const store = document.getElementById('storeName').value.trim() || "æœªåˆ†é¡";
    const name = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    if (!name || isNaN(price)) return alert("è«‹è¼¸å…¥å•†å“åç¨±èˆ‡åƒ¹æ ¼");

    if (editingTarget) {
        storeData[editingTarget.store].splice(editingTarget.index, 1);
        if (storeData[editingTarget.store].length === 0) delete storeData[editingTarget.store];
    }

    if (!storeData[store]) storeData[store] = [];
    storeData[store].push({
        name, price, 
        count: parseInt(document.getElementById('count').value) || 1,
        unit: document.getElementById('unitSelect').value,
        photos: currentPhotos.filter(p => p !== null),
        date: new Date().toLocaleDateString()
    });

    localStorage.setItem('storeTabsData', JSON.stringify(storeData));
    editingTarget = null;
    currentPhotos = [null, null, null];
    renderPhotoSlots();
    resetForm();
    renderTabs(store);
}

function renderTabs(activeStore = null) {
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    const controls = document.getElementById('tab-controls');
    const stores = Object.keys(storeData);

    if (stores.length === 0) { 
        headers.innerHTML = ""; contents.innerHTML = "å°šç„¡ç´€éŒ„"; controls.innerHTML = "";
        return; 
    }
    const currentStore = activeStore || stores[0];

    controls.innerHTML = `<small onclick="deleteStore('${currentStore}')" style="color:var(--danger); cursor:pointer; font-weight:bold;">ğŸ—‘ï¸ åˆªé™¤å•†åº—è³‡æ–™å¤¾</small>`;
    headers.innerHTML = stores.map(s => `<div class="tab-btn ${s===currentStore?'active':''}" onclick="renderTabs('${s}')">${s}</div>`).join('');
    
    contents.innerHTML = storeData[currentStore].slice().reverse().map((r, i) => {
        const originalIndex = storeData[currentStore].length - 1 - i;
        return `
        <div class="record-item">
            <div style="display:flex; justify-content:space-between; align-items: flex-start;">
                <div>
                    <b style="font-size:16px;">${r.name}</b><br>
                    <small style="color:#999;">${r.date} | ${r.count} ${r.unit}</small>
                </div>
                <span style="color:var(--primary); font-weight:800; font-size:20px;">$${r.price}</span>
            </div>
            <div class="record-photos">
                ${r.photos.map(p => `<img src="${p}" onclick="openLightbox('${p}')">`).join('')}
            </div>
            <div style="margin-top:10px; border-top: 1px dashed #eee; padding-top: 10px;">
                <span class="action-link" onclick="editItem('${currentStore}', ${originalIndex})">âœï¸ ç·¨è¼¯</span>
                <span class="action-link" style="color:var(--danger)" onclick="deleteItem('${currentStore}', ${originalIndex})">ğŸ—‘ï¸ åˆªé™¤</span>
            </div>
        </div>
    `}).join('');
}

// --- ç´šè¯ç·¨åˆªåŠŸèƒ½ ---
function deleteStore(name) {
    if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿé€™æœƒä¸€ä½µåˆªé™¤å…§å®¹èˆ‡ç…§ç‰‡ä¸”ç„¡æ³•å¾©åŸï¼`)) {
        delete storeData[name];
        localStorage.setItem('storeTabsData', JSON.stringify(storeData));
        renderTabs();
    }
}

function deleteItem(store, index) {
    if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ")) {
        storeData[store].splice(index, 1);
        if (storeData[store].length === 0) delete storeData[store];
        localStorage.setItem('storeTabsData', JSON.stringify(storeData));
        renderTabs(storeData[store] ? store : null);
    }
}

function editItem(store, index) {
    const r = storeData[store][index];
    document.getElementById('storeName').value = store;
    document.getElementById('itemName').value = r.name;
    document.getElementById('price').value = r.price;
    document.getElementById('count').value = r.count;
    refreshUnitSelect(r.unit);
    
    currentPhotos = [null, null, null];
    if (r.photos) r.photos.forEach((p, i) => currentPhotos[i] = p);
    renderPhotoSlots();
    
    editingTarget = { store, index };
    document.getElementById('btnSave').innerText = "ğŸ†™ æ›´æ–°ç´€éŒ„";
    document.getElementById('btnSave').style.background = "var(--primary)";
    window.scrollTo({top: 0, behavior: 'smooth'});
}

// --- ğŸ› ï¸ å…¶ä»–å·¥å…· ---
async function performOCR(file) {
    const status = document.getElementById('btnSave');
    const originalText = status.innerText;
    status.innerText = "â³ è¾¨è­˜ä¸­...";
    try {
        const worker = await Tesseract.createWorker('chi_tra');
        const { data: { text } } = await worker.recognize(file);
        document.getElementById('itemName').value = text.split('\n')[0].trim();
        await worker.terminate();
    } catch(e) { console.error(e); }
    status.innerText = originalText;
}

function resetForm() {
    document.getElementById('itemName').value = "";
    document.getElementById('price').value = "";
    document.getElementById('count').value = "1";
    document.getElementById('btnSave').innerText = "âœ… å„²å­˜æ­¤ç´€éŒ„";
    document.getElementById('btnSave').style.background = "var(--success)";
}

function escapeHtml(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

window.onload = () => {
    storeData = JSON.parse(localStorage.getItem('storeTabsData')) || {};
    unitList = JSON.parse(localStorage.getItem('managedUnits')) || [];
    refreshUnitSelect();
    renderTabs();
};
</script>
</body>
</html>
