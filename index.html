<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾æº–æ¯”åƒ¹å°å¹«æ‰‹ - V3.6.1 å¤šåœ–ç‰ˆ ğŸ”’</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --card: #ffffff; --success: #27ae60; --danger: #ff4d4f; --warning: #f1c40f; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; color:#333; }
        .container { width:100%; max-width:480px; background:var(--card); padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.08); box-sizing:border-box; }
        
        /* ğŸ“¸ å¤šåœ–ä¸Šå‚³å€ */
        .photo-upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .photo-slot { aspect-ratio: 1; border: 2px dashed #ddd; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; background: #fafafa; overflow: hidden; }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        .photo-slot .remove-p { position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.7); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; text-align: center; line-height: 18px; }
        
        .input-group { margin-bottom:12px; }
        label { display:block; margin-bottom:4px; font-size:13px; font-weight:bold; color:#666; }
        input, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:15px; box-sizing:border-box; }
        button { width:100%; padding:14px; border:none; border-radius:14px; font-size:16px; font-weight:bold; cursor:pointer; margin-bottom:10px; }
        .btn-save { background:var(--success); color:white; }
        
        /* ç´€éŒ„å‘ˆç¾ */
        .record-item { background:#fff; padding:12px; border-radius:14px; margin-bottom:10px; border:1px solid #eee; }
        .record-photos { display: flex; gap: 5px; margin-top: 8px; }
        .record-photos img { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; border: 1px solid #eee; }
        
        .tab-btn { background:#eee; padding:8px 15px; border-radius:15px; font-size:13px; cursor:pointer; white-space:nowrap; }
        .tab-btn.active { background:var(--primary); color:white; }
        .tab-headers { display:flex; gap:8px; overflow-x:auto; padding-bottom:10px; }
        .action-link { font-size:12px; color:var(--primary); margin-right:10px; cursor:pointer; font-weight:bold; }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align:center; color:var(--primary); margin-top:0;">ğŸ›’ æ¯”åƒ¹åŠ©æ‰‹ V3.6.1+</h2>

    <label>ğŸ“¸ å•†å“ç…§ç‰‡ (æœ€å¤š3å¼µ)</label>
    <div class="photo-upload-grid">
        <div class="photo-slot" onclick="triggerFile(0)" id="slot-0"><span>+</span></div>
        <div class="photo-slot" onclick="triggerFile(1)" id="slot-1"><span>+</span></div>
        <div class="photo-slot" onclick="triggerFile(2)" id="slot-2"><span>+</span></div>
    </div>
    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">

    <div class="input-group"><label>ğŸª å•†åº—</label><input type="text" id="storeName" placeholder="å•†åº—åç¨±"></div>
    <div class="input-group"><label>ğŸ“¦ å“å (æ‹ç…§è¾¨è­˜è«‹é»é¸ç…§ç‰‡æ¡†)</label><input type="text" id="itemName" placeholder="å•†å“åç¨±"></div>
    
    <div style="display:flex; gap:8px;">
        <div class="input-group" style="flex:2;"><label>ğŸ’µ ç¸½åƒ¹</label><input type="number" id="price"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ”¢ æ•¸é‡</label><input type="number" id="count" value="1"></div>
        <div class="input-group" style="flex:1;"><label>ğŸ“ å–®ä½</label><select id="unitSelect"></select></div>
    </div>

    <button class="btn-save" id="btnSave" onclick="saveRecord()">âœ… å„²å­˜æ­¤ç´€éŒ„</button>

    <div id="store-tabs-container">
        <div id="tab-controls" style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:5px;"></div>
        <div id="tab-headers" class="tab-headers"></div>
        <div id="tab-contents"></div>
    </div>
</div>

<script>
let storeData = {}; 
let currentPhotos = [null, null, null];
let editingTarget = null;
let currentSlotIndex = 0;

// --- ğŸ“¸ ç…§ç‰‡è™•ç†é‚è¼¯ ---
function triggerFile(index) {
    currentSlotIndex = index;
    document.getElementById('file-input').click();
}

async function handleFile(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    
    // 1. åŸ·è¡Œ OCR è¾¨è­˜ (åƒ…é‡å°ç¬¬ä¸€å¼µåœ–)
    if (currentSlotIndex === 0) performOCR(file);

    // 2. å£“ç¸®ä¸¦è½‰å­˜ Base64
    const base64 = await compressImage(file);
    currentPhotos[currentSlotIndex] = base64;
    renderPhotoSlots();
}

function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const max_size = 400; // é™åˆ¶é•·å¯¬é¿å…å„²å­˜çˆ†æ‰
                let w = img.width, h = img.height;
                if (w > h) { if (w > max_size) { h *= max_size / w; w = max_size; } }
                else { if (h > max_size) { w *= max_size / h; h = max_size; } }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
        };
    });
}

function renderPhotoSlots() {
    currentPhotos.forEach((data, i) => {
        const slot = document.getElementById(`slot-${i}`);
        if (data) {
            slot.innerHTML = `<img src="${data}"><div class="remove-p" onclick="event.stopPropagation();removePhoto(${i})">Ã—</div>`;
        } else {
            slot.innerHTML = `<span>+</span>`;
        }
    });
}

function removePhoto(i) {
    currentPhotos[i] = null;
    renderPhotoSlots();
}

// --- ğŸ’¾ è³‡æ–™å„²å­˜èˆ‡ç´šè¯ç·¨åˆª ---
function saveRecord() {
    const store = document.getElementById('storeName').value.trim() || "æœªåˆ†é¡";
    const name = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    if (!name || isNaN(price)) return alert("è«‹å¡«å¯«å®Œæ•´");

    if (editingTarget) {
        storeData[editingTarget.store].splice(editingTarget.index, 1);
        if (storeData[editingTarget.store].length === 0) delete storeData[editingTarget.store];
    }

    if (!storeData[store]) storeData[store] = [];
    storeData[store].push({
        name, price, 
        count: parseInt(document.getElementById('count').value) || 1,
        unit: document.getElementById('unitSelect').value,
        photos: [...currentPhotos.filter(p => p !== null)], // åªå­˜æœ‰ç…§ç‰‡çš„
        date: new Date().toLocaleDateString()
    });

    localStorage.setItem('storeTabsData', JSON.stringify(storeData));
    editingTarget = null;
    currentPhotos = [null, null, null];
    renderPhotoSlots();
    resetForm();
    renderTabs(store);
}

function renderTabs(activeStore = null) {
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    const controls = document.getElementById('tab-controls');
    const stores = Object.keys(storeData);

    if (stores.length === 0) { contents.innerHTML = "å°šç„¡ç´€éŒ„"; return; }
    const currentStore = activeStore || stores[0];

    controls.innerHTML = `<small onclick="deleteStore('${currentStore}')" style="color:red; cursor:pointer;">ğŸ—‘ï¸ åˆªé™¤æ­¤åº—</small>`;
    headers.innerHTML = stores.map(s => `<div class="tab-btn ${s===currentStore?'active':''}" onclick="renderTabs('${s}')">${s}</div>`).join('');
    
    contents.innerHTML = storeData[currentStore].map((r, i) => `
        <div class="record-item">
            <div style="display:flex; justify-content:space-between;">
                <b>${r.name}</b>
                <span style="color:var(--primary); font-weight:800;">$${r.price}</span>
            </div>
            <div class="record-photos">
                ${r.photos ? r.photos.map(p => `<img src="${p}" onclick="window.open().document.write('<img src=\\'${p}\\'>')">`).join('') : ''}
            </div>
            <div style="margin-top:8px;">
                <span class="action-link" onclick="editItem('${currentStore}', ${i})">âœï¸ ç·¨è¼¯</span>
                <span class="action-link" style="color:red" onclick="deleteItem('${currentStore}', ${i})">ğŸ—‘ï¸ åˆªé™¤</span>
            </div>
        </div>
    `).reverse().join('');
}

function deleteStore(name) {
    if (confirm("ç¢ºå®šåˆªé™¤æ•´å€‹å•†åº—è³‡æ–™å¤¾èˆ‡ç…§ç‰‡ï¼Ÿ")) { delete storeData[name]; localStorage.setItem('storeTabsData', JSON.stringify(storeData)); renderTabs(); }
}

function deleteItem(store, index) {
    if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) { storeData[store].splice(index, 1); if (storeData[store].length === 0) delete storeData[store]; localStorage.setItem('storeTabsData', JSON.stringify(storeData)); renderTabs(store); }
}

function editItem(store, index) {
    const r = storeData[store][index];
    document.getElementById('storeName').value = store;
    document.getElementById('itemName').value = r.name;
    document.getElementById('price').value = r.price;
    document.getElementById('count').value = r.count;
    currentPhotos = [null, null, null];
    if (r.photos) r.photos.forEach((p, i) => currentPhotos[i] = p);
    renderPhotoSlots();
    editingTarget = { store, index };
    document.getElementById('btnSave').innerText = "ğŸ†™ æ›´æ–°ç´€éŒ„";
    window.scrollTo(0,0);
}

// --- ğŸ› ï¸ è¼”åŠ©åŠŸèƒ½ (OCR, Resetç­‰) ---
async function performOCR(file) {
    const worker = await Tesseract.createWorker('chi_tra');
    const { data: { text } } = await worker.recognize(file);
    document.getElementById('itemName').value = text.split('\n')[0].trim();
    await worker.terminate();
}

function resetForm() {
    document.getElementById('itemName').value = "";
    document.getElementById('price').value = "";
    document.getElementById('btnSave').innerText = "âœ… å„²å­˜æ­¤ç´€éŒ„";
}

window.onload = () => {
    storeData = JSON.parse(localStorage.getItem('storeTabsData')) || {};
    const sel = document.getElementById('unitSelect');
    ["å…¥","å€‹","å…‹","æ¯«å‡"].forEach(u => sel.add(new Option(u, u)));
    renderTabs();
};
</script>
</body>
</html>
