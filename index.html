<script>
let db = JSON.parse(localStorage.getItem('shopRecords')) || [];
let storeData = JSON.parse(localStorage.getItem('storeTabsData')) || {};

async function performOCR(input) {
    if (!input.files || !input.files[0]) return;
    const status = document.getElementById('ocr-status');
    const itemNameInput = document.getElementById('itemName');
    status.innerText = "⌛ 辨識中...";
    
    try {
        const worker = await Tesseract.createWorker('chi_tra+eng');
        const { data: { text, lines } } = await worker.recognize(input.files[0]);
        await worker.terminate();

        const cleanLines = lines.map(l => l.text.trim()).filter(l => l.length > 0);
        let candidates = [];
        let detectedName = "";
        let nameLineIdx = -1;

        const semanticPriceRegex = /(?:[$¥]|NT\$|特價|售價|金額)[:：\s]*([\d,]{2,7}(?:\.\d{1,2})?)/i;
        const pureNumberBarcodeRegex = /^\d{5,13}$/;

        // 用於前兩行品名合併
        let nameLinesBuffer = [];

        // 第一輪：掃描
        cleanLines.forEach((line, i) => {
            // 抓價格
            const sMatch = line.match(semanticPriceRegex);
            if (sMatch) {
                candidates.push({ val: parseFloat(sMatch[1].replace(/,/g, '')), score: 100, idx: i });
            }

            // 抓品名 (找前兩行有中文且不是數字的)
            if (/[\u4e00-\u9fa5]/.test(line) && !pureNumberBarcodeRegex.test(line) && nameLinesBuffer.length < 2) {
                nameLinesBuffer.push(line.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '').trim());
                if (nameLineIdx === -1) nameLineIdx = i;
            }

            // Fallback 價格
            if (!sMatch && !pureNumberBarcodeRegex.test(line)) {
                const fMatches = line.match(/([\d,]{2,6})/g);
                if (fMatches) {
                    fMatches.forEach(m => {
                        const val = parseFloat(m.replace(/,/g, ''));
                        if (val > 5 && val < 100000) candidates.push({ val, score: 50, idx: i });
                    });
                }
            }
        });

        // 合併前兩行品名
        detectedName = nameLinesBuffer.join(' ').trim();

        // 第二輪：距離加分
        if (nameLineIdx !== -1) {
            candidates.forEach(c => {
                const dist = Math.abs(c.idx - nameLineIdx);
                c.score += (15 - Math.min(dist, 15));
            });
        }

        const best = candidates.sort((a, b) => b.score - a.score)[0];
        document.getElementById('price').value = best ? best.val : '';
        itemNameInput.value = detectedName;
        status.innerText = "✅ 辨識完成";
    } catch (e) {
        status.innerText = "❌ 辨識出錯";
        console.error(e);
    }
}

function saveRecord() {
    const name = document.getElementById('itemName').value;
    const price = document.getElementById('price').value;
    const store = document.getElementById('storeName').value || "未分類";
    
    if (!name || !price) return alert("請填寫名稱與價格");

    const record = { name, price: parseFloat(price), date: new Date().toLocaleDateString() };
    if (!storeData[store]) storeData[store] = [];
    storeData[store].push(record);
    
    localStorage.setItem('storeTabsData', JSON.stringify(storeData));
    renderTabs(store);
}

function renderTabs(activeStore = null) {
    const headers = document.getElementById('tab-headers');
    const contents = document.getElementById('tab-contents');
    const names = Object.keys(storeData);
    
    headers.innerHTML = names.map(n => `
        <div class="tab-btn ${n === activeStore ? 'active' : ''}" onclick="renderTabs('${n}')">${n}</div>
    `).join('');

    const list = storeData[activeStore] || [];
    contents.innerHTML = list.slice().reverse().map(r => `
        <div class="record-item">
            <div><b>${escapeHtml(r.name)}</b><br><small>${r.date}</small></div>
            <div>$${r.price}</div>
        </div>
    `).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

window.onload = () => renderTabs();
</script>
