<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶åº­é›²ç«¯åŒæ­¥è¡Œäº‹æ›† (å«æ™‚æ•¸çµ±è¨ˆç‰ˆ)</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); color: #333; -webkit-tap-highlight-color: transparent; }
        
        .app-container { max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; min-height: 800px; position: relative; }
        header { background: var(--primary); color: white; padding: 15px 20px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h1 { margin: 0; font-size: 1.5rem; }
        .status-indicator { font-size: 0.8rem; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; }
        .nav-tabs { display: flex; gap: 5px; }
        .nav-btn { background: rgba(255,255,255,0.1); border: none; color: #ddd; padding: 10px 20px; cursor: pointer; border-radius: 8px 8px 0 0; font-size: 1rem; }
        .nav-btn.active { background: white; color: var(--primary); font-weight: bold; }
        
        /* æˆå“¡ç®¡ç†æ¨£å¼ */
        .user-bar { background: #ecf0f1; padding: 12px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
        .user-chip { 
            background: white; padding: 6px 12px; border-radius: 20px; cursor: pointer; 
            display: flex; align-items: center; gap: 6px; border: 2px solid transparent; 
            transition: all 0.2s; user-select: none;
        }
        .user-chip:hover { border-color: #ddd; }
        .user-chip.active { border-color: currentColor; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-dot-icon { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .user-del-btn { 
            width: 18px; height: 18px; border-radius: 50%; background: #eee; color: #888; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; margin-left: 5px;
            cursor: pointer; opacity: 0.6; transition: 0.2s;
        }
        .user-del-btn:hover { background: #e74c3c; color: white; opacity: 1; }

        .page { display: none; padding: 25px; }
        .page.active { display: block; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; color: white; background: var(--secondary); }
        .btn-danger { background: #e74c3c; }
        .btn-success { background: #27ae60; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #333; }
        
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .cat-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sub-chip { display: inline-flex; background: #e0f2f1; color: #00796b; padding: 4px 10px; border-radius: 12px; margin: 4px; font-size: 0.9rem; cursor: pointer; }
        .cat-input { font-size: 1.1rem; font-weight: bold; color: var(--primary); border: none; border-bottom: 1px solid transparent; width: 100%; margin-bottom: 10px; }
        .cat-input:focus { border-bottom: 1px solid var(--secondary); outline: none; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #ccc; gap: 1px; border: 1px solid #ccc; }
        .cal-head { background: var(--primary); color: white; text-align: center; padding: 10px 0; font-size: 0.9rem; }
        .cal-day { background: white; min-height: 100px; padding: 5px; cursor: pointer; position: relative; }
        .cal-day:hover { background: #f9f9f9; }
        .day-num { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; }
        .dot-container { display: flex; flex-wrap: wrap; gap: 2px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

        .stat-table, .log-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .stat-table th, .log-table th { background: #f8f9fa; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
        .stat-table td, .log-table td { padding: 10px; border-bottom: 1px solid #eee; }
        
        /* è©³æƒ…é æ¨£å¼ */
        .detail-card { border-left: 5px solid #ccc; background: #fdfdfd; padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .detail-time { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        .detail-title { font-size: 1.1rem; font-weight: bold; }
        .detail-user { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; color: white; margin-left: 8px; vertical-align: middle; }

        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        @media (max-width: 768px) {
            .app-container { margin: 0; border-radius: 0; min-height: 100vh; }
            .nav-btn { padding: 10px 10px; font-size: 0.9rem; }
            .cal-day { min-height: 60px; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="top-row">
            <h1>ğŸ“… å®¶åº­é›²ç«¯è¡Œäº‹æ›†</h1>
            <span class="status-indicator" id="status-text">â— é›¢ç·šæ¨¡å¼</span>
        </div>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchPage('home')">é¦–é </button>
            <button class="nav-btn" onclick="switchPage('log')">ç™»éŒ„</button>
            <button class="nav-btn" onclick="switchPage('settings')">è¨­å®š</button>
        </div>
    </header>

    <div class="user-bar">
        <span style="color:#777; font-weight:bold;">å°è±¡ï¼š</span>
        <div id="user-chips-container" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
        <button class="btn-outline" style="margin-left:auto; padding:4px 10px; font-size:0.8rem;" onclick="addUserPrompt()">+ æˆå“¡</button>
    </div>

    <div id="page-home" class="page active">
        <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
            <select id="stat-year" onchange="renderStats()"></select>
            <select id="stat-month" onchange="renderStats()"></select>
            <button class="btn btn-outline" onclick="toggleViewMode()" id="btn-view-mode">ğŸ‘ï¸ å…¨å“¡æ¨¡å¼</button>
        </div>
        
        <div class="calendar-grid" id="calendar-view"></div>
        
        <div style="margin-top:20px;">
            <h3>ğŸ“Š ç•¶æœˆç¸½çµ±è¨ˆ (å°æ™‚)</h3>
            <div style="overflow-x:auto;">
                <table class="stat-table">
                    <thead id="stat-table-head"></thead>
                    <tbody id="stat-table-body"></tbody>
                </table>
            </div>
        </div>

        <div style="margin-top:30px;">
            <h3>ğŸ“… æ¯é€±åˆ†é¡çµ±è¨ˆ (å°æ™‚)</h3>
            <div style="overflow-x:auto;">
                <table class="stat-table">
                    <thead id="weekly-table-head"></thead>
                    <tbody id="weekly-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="page-detail" class="page">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">
            <h2 id="detail-date-title" style="margin:0;">202X-XX-XX</h2>
            <div>
                <button class="btn btn-outline" onclick="switchPage('home')">â¬…ï¸ è¿”å›</button>
                <button class="btn btn-success" onclick="goToEditFromDetail()">âœï¸ ç·¨è¼¯</button>
            </div>
        </div>
        <div id="detail-list-container"></div>
    </div>

    <div id="page-log" class="page">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <input type="date" id="log-date" style="font-size:1.1rem;" onchange="loadDailyLog()">
            <button class="btn btn-success" onclick="addLogEntry()">+ æ–°å¢ç´€éŒ„</button>
        </div>
        <table class="log-table">
            <thead><tr><th>æ™‚é–“</th><th>é¡åˆ¥/ç´°é …</th><th>å‚™è¨»</th><th></th></tr></thead>
            <tbody id="log-entries"></tbody>
        </table>
        <div style="margin-top:30px; text-align:center;">
            <button class="btn" style="width:100%; padding:15px; font-size:1.1rem;" onclick="saveLogs()">ğŸ’¾ å„²å­˜ä¸¦ä¸Šå‚³</button>
        </div>
    </div>

    <div id="page-settings" class="page">
        <div style="background:#e8f4fd; padding:20px; border-radius:8px; display:flex; gap:10px; margin-bottom:20px; align-items:center;">
            <strong>æ–°å¢å¤§åˆ†é¡ï¼š</strong>
            <input type="text" id="new-cat-input" placeholder="è¼¸å…¥åç¨±" style="flex:1;">
            <button class="btn" onclick="addCategory()">æ–°å¢</button>
        </div>
        <div id="settings-grid" class="settings-grid"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // --- Firebase è¨­å®š (è«‹ç¢ºèªæ˜¯å¦éœ€è¦æ›å›æ‚¨çš„è¨­å®š) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBJELIYoh_nLF8evCrgFGKNa-sjMMZQRL0",
        authDomain: "lai-family-calender.firebaseapp.com",
        databaseURL: "https://lai-family-calender-default-rtdb.firebaseio.com",
        projectId: "lai-family-calender",
        storageBucket: "lai-family-calender.firebasestorage.app",
        messagingSenderId: "1039195042184",
        appId: "1:1039195042184:web:def8de663845bd518f8a3d"
    };

    let db = null;
    try {
        if (firebaseConfig.apiKey) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            document.getElementById('status-text').innerText = "â— ç·šä¸ŠåŒæ­¥ä¸­";
            document.getElementById('status-text').style.color = "#2ecc71";
        }
    } catch (e) {
        console.error(e);
        alert("Firebase Config è¨­å®šæœ‰èª¤");
    }

    const DB_ROOT = 'family_calendar_v1';
    let config = { "å¯«åŠŸèª²": ["æ•¸å­¸", "åœ‹èª"], "é‹å‹•": ["è·‘æ­¥"] };
    let users = ["å¯¶è²A", "å¯¶è²B"];
    let allData = {};
    let currentUser = users[0];
    let viewAllMode = true;
    let selectedDateForDetail = "";

    if(db) {
        db.ref(DB_ROOT).on('value', (snapshot) => {
            const val = snapshot.val();
            if(val) {
                if(val.config) config = val.config;
                if(val.users) users = val.users;
                if(val.data) allData = val.data;
                
                if(!users.includes(currentUser) && users.length > 0) {
                    currentUser = users[0];
                }
                
                refreshUI(); 
            }
        });
    }

    // --- æˆå“¡ç®¡ç†åŠŸèƒ½ ---
    function addUserPrompt() {
        const name = prompt("è«‹è¼¸å…¥æ–°æˆå“¡åå­—ï¼š");
        if(name && !users.includes(name)) {
            users.push(name);
            saveUsers();
        }
    }

    function deleteUser(e, name) {
        e.stopPropagation();
        if(confirm(`ç¢ºå®šè¦åˆªé™¤æˆå“¡ã€Œ${name}ã€å—ï¼Ÿ\næ³¨æ„ï¼šè©²æˆå“¡çš„æ­·å²ç´€éŒ„å°‡ä¿ç•™åœ¨è³‡æ–™åº«ä¸­ä½†ä¸å†é¡¯ç¤ºã€‚`)) {
            users = users.filter(u => u !== name);
            if(currentUser === name && users.length > 0) currentUser = users[0];
            saveUsers();
        }
    }

    function renameUser(oldName) {
        const newName = prompt(`è«‹è¼¸å…¥ã€Œ${oldName}ã€çš„æ–°åå­—ï¼š`, oldName);
        if(newName && newName !== oldName) {
            if(users.includes(newName)) {
                alert("è©²åå­—å·²å­˜åœ¨ï¼");
                return;
            }
            const idx = users.indexOf(oldName);
            if(idx !== -1) users[idx] = newName;
            if(currentUser === oldName) currentUser = newName;

            if(allData[oldName]) {
                allData[newName] = allData[oldName];
                delete allData[oldName];
                
                if(db) {
                    const updates = {};
                    updates[`${DB_ROOT}/data/${newName}`] = allData[newName];
                    updates[`${DB_ROOT}/data/${oldName}`] = null;
                    updates[`${DB_ROOT}/users`] = users;
                    db.ref().update(updates)
                      .then(() => alert(`æˆå“¡ã€Œ${oldName}ã€å·²æ›´åç‚ºã€Œ${newName}ã€`))
                      .catch(err => alert("æ›´åå¤±æ•—ï¼š" + err));
                }
            } else {
                saveUsers();
            }
        }
    }

    function saveUsers() {
        if(db) db.ref(DB_ROOT + '/users').set(users);
        else refreshUI();
    }

    // --- è¨­å®šåŠŸèƒ½ ---
    function addCategory() {
        const input = document.getElementById('new-cat-input');
        const val = input.value.trim();
        if (!val) { alert("è«‹è¼¸å…¥åˆ†é¡åç¨±ï¼"); return; }
        if (config[val]) { alert("é€™å€‹åˆ†é¡å·²ç¶“å­˜åœ¨å›‰ï¼"); return; }
        
        config[val] = []; 
        input.value = '';
        saveConfig();      
    }

    function removeCat(cat) {
        if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${cat}ã€å—ï¼Ÿ`)) {
            delete config[cat];
            saveConfig();
        }
    }

    function addSub(cat) {
        const input = document.getElementById(`add-sub-${cat}`);
        const val = input.value.trim();
        if(val && !config[cat].includes(val)) {
            config[cat].push(val);
            saveConfig();
        }
    }

    function removeSub(cat, sub) {
        if(confirm(`ç§»é™¤ç´°é …ã€Œ${sub}ã€ï¼Ÿ`)) {
            config[cat] = config[cat].filter(s => s !== sub);
            saveConfig();
        }
    }

    function updateCatTitle(oldName, input) {
        const newName = input.value.trim();
        if(newName && newName !== oldName && !config[newName]) {
            config[newName] = config[oldName];
            delete config[oldName];
            saveConfig();
        }
    }

    function saveConfig() {
        if(db) db.ref(DB_ROOT + '/config').set(config);
        renderSettings();
    }

    // --- æ ¸å¿ƒåŠŸèƒ½èˆ‡ UI ---
    function saveLogs() {
        const date = document.getElementById('log-date').value;
        const rows = document.querySelectorAll('.log-row');
        const newData = [];
        rows.forEach(r => {
            const s = r.querySelector('.t-start').value;
            const e = r.querySelector('.t-end').value;
            const cat = r.querySelector('.sel-cat').value;
            const sub = r.querySelector('.sel-sub').value;
            const note = r.querySelector('.inp-note').value;
            if(s && e && cat) newData.push({ start:s, end:e, cat, sub, note });
        });

        if(!allData[currentUser]) allData[currentUser] = {};
        allData[currentUser][date] = newData;

        if(db) {
            db.ref(`${DB_ROOT}/data/${currentUser}/${date}`).set(newData)
              .then(() => alert("âœ… å„²å­˜æˆåŠŸï¼"))
              .catch(e => alert("âŒ å„²å­˜å¤±æ•—"));
        } else {
            alert("å·²æš«å­˜ (é›¢ç·šæ¨¡å¼)");
            refreshUI();
        }
    }

    function refreshUI() {
        renderUserChips();
        if(document.getElementById('page-settings').classList.contains('active')) renderSettings();
        if(document.getElementById('page-home').classList.contains('active')) renderStats();
        if(document.getElementById('page-log').classList.contains('active')) loadDailyLog();
        
        // ç¢ºä¿è©³æƒ…é è³‡æ–™è¢«æ­£ç¢ºæ¸²æŸ“
        if(document.getElementById('page-detail').classList.contains('active') && selectedDateForDetail) {
            renderDetailView();
        }
    }

    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        
        const idx = {'home':0, 'log':1, 'settings':2}[pageId];
        if(idx !== undefined) document.querySelectorAll('.nav-btn')[idx].classList.add('active');
        refreshUI();
    }

    // --- è©³æƒ…é é‚è¼¯ (MODIFIED: åŠ å…¥æ™‚é–“é¡¯ç¤ºèˆ‡åº•éƒ¨çµ±è¨ˆ) ---
    window.openDayDetail = function(dateStr) {
        selectedDateForDetail = dateStr;
        switchPage('detail'); 
    }

    function renderDetailView() {
        if(!selectedDateForDetail) return;
        
        const dateStr = selectedDateForDetail;
        
        // è¨ˆç®—æ˜ŸæœŸå¹¾
        const [y, m, d] = dateStr.split('-').map(Number);
        const weekDay = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(y, m-1, d).getDay()];

        // è¨­å®šæ¨™é¡Œ
        document.getElementById('detail-date-title').innerText = `${dateStr} (${weekDay}) è¡Œç¨‹è©³æƒ…`;
        
        const container = document.getElementById('detail-list-container');
        container.innerHTML = '';

        let events = [];
        const targetUsers = viewAllMode ? users : [currentUser];

        targetUsers.forEach(u => {
            const logs = allData[u]?.[dateStr] || [];
            logs.forEach(l => events.push({ ...l, user: u }));
        });

        events.sort((a, b) => a.start.localeCompare(b.start));

        if(events.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:30px; color:#888;">ä»Šæ—¥ç„¡è¡Œç¨‹</div>';
            return;
        }

        // ç”¨ä¾†å„²å­˜ç•¶æ—¥åˆ†é¡çµ±è¨ˆçš„ç‰©ä»¶
        let dailyStats = {};

        events.forEach(ev => {
            // 1. è¨ˆç®—è©²è¡Œç¨‹èŠ±è²»æ™‚é–“
            const durationHours = calculateDuration(ev.start, ev.end);
            
            // 2. ç´¯åŠ åˆ°åˆ†é¡çµ±è¨ˆä¸­ (å¦‚æœå°šæœªæœ‰è©²åˆ†é¡ï¼Œåˆå§‹åŒ–ç‚º0)
            if (!dailyStats[ev.cat]) dailyStats[ev.cat] = 0;
            dailyStats[ev.cat] += durationHours;

            // 3. æ ¼å¼åŒ–é¡¯ç¤ºå­—ä¸² (ä¾‹å¦‚: "3å°æ™‚ 30åˆ†" æˆ– "45åˆ†")
            const totalMinutes = Math.round(durationHours * 60);
            let durationStr = "";
            if (totalMinutes >= 60) {
                const h = Math.floor(totalMinutes / 60);
                const min = totalMinutes % 60;
                durationStr = `${h}å°æ™‚` + (min > 0 ? ` ${min}åˆ†` : "");
            } else {
                durationStr = `${totalMinutes}åˆ†`;
            }

            const uColor = getUserColor(ev.user);
            const card = document.createElement('div');
            card.className = 'detail-card';
            card.style.borderLeftColor = uColor;
            
            // HTML è¼¸å‡ºï¼šåœ¨æ™‚é–“å¾Œé¢åŠ å…¥ (â±ï¸ æ™‚é–“é•·åº¦)
            card.innerHTML = `
                <span class="detail-time">
                    ${ev.start} - ${ev.end} 
                    <span style="font-weight:normal; color:#888; font-size:0.9em; margin-left:5px;">(â±ï¸ ${durationStr})</span>
                    <span class="detail-user" style="background:${uColor}">${ev.user}</span>
                </span>
                <div class="detail-title">
                    ${ev.cat} ${ev.sub ? '- '+ev.sub : ''} 
                    <span style="font-weight:normal; font-size:0.9rem; color:#666;">${ev.note ? '('+ev.note+')' : ''}</span>
                </div>
            `;
            container.appendChild(card);
        });

        // 4. åœ¨æœ€ä¸‹æ–¹æ¸²æŸ“ç•¶æ—¥çµ±è¨ˆè¡¨æ ¼
        if (Object.keys(dailyStats).length > 0) {
            const statDiv = document.createElement('div');
            statDiv.style.marginTop = "30px";
            statDiv.style.borderTop = "2px dashed #eee";
            statDiv.style.paddingTop = "15px";
            
            let statRows = '';
            let totalDayHours = 0;
            
            // éæ­·çµ±è¨ˆæ•¸æ“šç”¢ç”Ÿè¡¨æ ¼è¡Œ
            for (const [cat, hours] of Object.entries(dailyStats)) {
                totalDayHours += hours;
                statRows += `
                    <tr>
                        <td>${cat}</td>
                        <td style="text-align:right; font-weight:bold;">${hours.toFixed(1)} å°æ™‚</td>
                    </tr>
                `;
            }

            statDiv.innerHTML = `
                <h3 style="color:#555;">ğŸ“‰ æœ¬æ—¥åˆ†é¡çµ±è¨ˆç¸½çµ</h3>
                <table class="stat-table" style="font-size:0.95rem;">
                    <thead>
                        <tr>
                            <th style="background:#f4f7f6;">åˆ†é¡é …ç›®</th>
                            <th style="background:#f4f7f6; text-align:right;">èŠ±è²»æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${statRows}
                        <tr style="border-top:2px solid #ddd; background:#fffdf0;">
                            <td><strong>ç¸½è¨ˆ</strong></td>
                            <td style="text-align:right; color:#e67e22;"><strong>${totalDayHours.toFixed(1)} å°æ™‚</strong></td>
                        </tr>
                    </tbody>
                </table>
            `;
            container.appendChild(statDiv);
        }
    }

    window.goToEditFromDetail = function() {
        if(selectedDateForDetail) {
            document.getElementById('log-date').value = selectedDateForDetail;
            switchPage('log');
        }
    }

    // --- æœˆæ›†èˆ‡çµ±è¨ˆ ---
    function renderStats() {
        const y = parseInt(document.getElementById('stat-year').value);
        const m = parseInt(document.getElementById('stat-month').value);
        const cal = document.getElementById('calendar-view');
        cal.innerHTML = '';

        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => cal.innerHTML += `<div class="cal-head">${d}</div>`);
        const firstDay = new Date(y, m-1, 1).getDay();
        for(let i=0; i<firstDay; i++) cal.innerHTML += `<div class="cal-day" style="background:#eee;"></div>`;
        
        const daysInMonth = new Date(y, m, 0).getDate();
        const statData = {}; 
        const weeklyData = { 1:{}, 2:{}, 3:{}, 4:{}, 5:{}, 6:{} };

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement('div');
            cell.className = 'cal-day';
            cell.onclick = function() { openDayDetail(dateStr); }; 
            
            const weekNum = Math.floor((d + firstDay - 1) / 7) + 1;

            let dotsHtml = '<div class="dot-container">';
            users.forEach(u => {
                if(!viewAllMode && u !== currentUser) return;

                const logs = allData[u]?.[dateStr] || [];
                if(logs.length > 0) {
                    dotsHtml += `<span class="dot" style="background:${getUserColor(u)}" title="${u}"></span>`;
                    logs.forEach(l => {
                        const dur = calculateDuration(l.start, l.end);
                        if(!statData[u]) statData[u] = {};
                        if(!statData[u][l.cat]) statData[u][l.cat] = 0;
                        statData[u][l.cat] += dur;

                        if(!weeklyData[weekNum][l.cat]) weeklyData[weekNum][l.cat] = 0;
                        weeklyData[weekNum][l.cat] += dur;
                    });
                }
            });
            dotsHtml += '</div>';
            cell.innerHTML = `<span class="day-num">${d}</span>${dotsHtml}`;
            cal.appendChild(cell);
        }
        
        renderStatTable(statData);
        renderWeeklyTable(weeklyData);
    }

    function renderWeeklyTable(wData) {
        const thead = document.getElementById('weekly-table-head');
        const tbody = document.getElementById('weekly-table-body');
        thead.innerHTML = '<tr><th>é€±æ¬¡</th>' + Object.keys(config).map(c => `<th>${c}</th>`).join('') + '</tr>';
        tbody.innerHTML = '';
        
        for(let w=1; w<=6; w++) {
            const hasData = Object.values(wData[w]).some(v => v > 0);
            if(!hasData && w > 4) continue;

            let rowHtml = `<td>ç¬¬ ${w} é€±</td>`;
            Object.keys(config).forEach(cat => {
                const val = wData[w][cat] || 0;
                rowHtml += `<td>${val.toFixed(1)}</td>`;
            });
            tbody.innerHTML += `<tr>${rowHtml}</tr>`;
        }
    }

    function calculateDuration(start, end) {
        if(!start || !end) return 0;
        const [h1, m1] = start.split(':').map(Number);
        const [h2, m2] = end.split(':').map(Number);
        return ((h2*60+m2) - (h1*60+m1)) / 60;
    }

    function renderStatTable(data) {
        const thead = document.getElementById('stat-table-head');
        const tbody = document.getElementById('stat-table-body');
        thead.innerHTML = '<tr><th>æˆå“¡</th>' + Object.keys(config).map(c => `<th>${c}</th>`).join('') + '<th>ç¸½è¨ˆ</th></tr>';
        tbody.innerHTML = '';
        users.forEach(u => {
            if(!viewAllMode && u !== currentUser) return;
            const uData = data[u] || {};
            let rowTotal = 0;
            let rowHtml = `<td><span class="dot" style="background:${getUserColor(u)}"></span> ${u}</td>`;
            Object.keys(config).forEach(cat => {
                const val = uData[cat] || 0;
                rowTotal += val;
                rowHtml += `<td>${val.toFixed(1)}</td>`;
            });
            rowHtml += `<td><strong>${rowTotal.toFixed(1)}</strong></td>`;
            tbody.innerHTML += `<tr>${rowHtml}</tr>`;
        });
    }

    function renderSettings() {
        const grid = document.getElementById('settings-grid');
        grid.innerHTML = '';
        Object.keys(config).forEach(cat => {
            const card = document.createElement('div');
            card.className = 'cat-card';
            let subHtml = config[cat].map(s => `<span class="sub-chip" onclick="removeSub('${cat}', '${s}')">${s} âœ•</span>`).join('');
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <input class="cat-input" value="${cat}" onchange="updateCatTitle('${cat}', this)">
                    <button class="btn-danger" style="padding:2px 8px; border-radius:4px; font-size:0.8rem;" onclick="removeCat('${cat}')">åˆªé™¤</button>
                </div>
                <div style="margin:10px 0;">${subHtml}</div>
                <div style="display:flex; gap:5px;">
                    <input id="add-sub-${cat}" placeholder="ç´°é …..." style="width:100px; font-size:0.9rem;">
                    <button class="btn-outline" onclick="addSub('${cat}')">+</button>
                </div>`;
            grid.appendChild(card);
        });
    }

    // --- æˆå“¡ Chips æ¸²æŸ“ ---
    function renderUserChips() {
        const c = document.getElementById('user-chips-container');
        c.innerHTML = '';
        users.forEach(u => {
            const isActive = u === currentUser;
            const color = getUserColor(u);
            const chip = document.createElement('div');
            chip.className = `user-chip ${isActive?'active':''}`;
            chip.style.color = isActive ? color : '#666';
            
            chip.ondblclick = () => renameUser(u);
            chip.onclick = () => { currentUser = u; refreshUI(); };
            
            const delBtn = document.createElement('span');
            delBtn.className = 'user-del-btn';
            delBtn.innerText = 'âœ•';
            delBtn.title = 'åˆªé™¤æˆå“¡';
            delBtn.onclick = (e) => deleteUser(e, u);

            chip.innerHTML = `<span class="user-dot-icon" style="background:${color}"></span> ${u}`;
            chip.appendChild(delBtn);
            
            chip.title = "é»æ“Šåˆ‡æ›ï¼Œå¿«é»å…©ä¸‹é‡æ–°å‘½å";
            c.appendChild(chip);
        });
    }

    const USER_COLORS = ['#3498db', '#e74c3c', '#27ae60', '#f39c12', '#9b59b6', '#8e44ad', '#16a085'];
    function getUserColor(name) { return USER_COLORS[users.indexOf(name) % USER_COLORS.length] || '#ccc'; }

    const now = new Date();
    const ySel = document.getElementById('stat-year');
    const mSel = document.getElementById('stat-month');
    for(let y=now.getFullYear()-1; y<=now.getFullYear()+1; y++) ySel.add(new Option(y+'å¹´', y));
    ySel.value = now.getFullYear();
    for(let m=1; m<=12; m++) mSel.add(new Option(m+'æœˆ', m));
    mSel.value = now.getMonth() + 1;
    document.getElementById('log-date').valueAsDate = now;

    renderSettings();
    renderUserChips();
    renderStats();

    function loadDailyLog() {
        const date = document.getElementById('log-date').value;
        const tbody = document.getElementById('log-entries');
        tbody.innerHTML = '';
        const data = allData[currentUser]?.[date] || [];
        if(data.length === 0) addLogEntry();
        else data.forEach(d => addLogEntry(d));
    }

    function addLogEntry(d = {}) {
        const tr = document.createElement('tr');
        tr.className = 'log-row';
        tr.innerHTML = `
            <td><input type="time" class="t-start" value="${d.start||'18:00'}">~<input type="time" class="t-end" value="${d.end||'18:30'}"></td>
            <td><select class="sel-cat" onchange="updSub(this)"></select><select class="sel-sub"></select></td>
            <td><input class="inp-note" value="${d.note||''}"></td>
            <td><button class="btn-danger" style="padding:4px;" onclick="this.closest('tr').remove()">âœ•</button></td>
        `;
        document.getElementById('log-entries').appendChild(tr);
        const selCat = tr.querySelector('.sel-cat');
        Object.keys(config).forEach(k => selCat.add(new Option(k, k)));
        if(d.cat && config[d.cat]) selCat.value = d.cat;
        updSub(selCat);
        if(d.sub) tr.querySelector('.sel-sub').value = d.sub;
    }

    window.updSub = function(sel) {
        const subSel = sel.closest('tr').querySelector('.sel-sub');
        subSel.innerHTML = '';
        const cat = sel.value;
        if(config[cat]) config[cat].forEach(s => subSel.add(new Option(s, s)));
    }
    
    function toggleViewMode() {
        viewAllMode = !viewAllMode;
        document.getElementById('btn-view-mode').innerText = viewAllMode ? "ğŸ‘ï¸ å…¨å“¡æ¨¡å¼" : "ğŸ‘¤ å€‹äººæ¨¡å¼";
        refreshUI();
    }
</script>
</body>
</html>